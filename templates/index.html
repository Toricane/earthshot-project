<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Learning Navigator</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <style>
            :root {
                --primary-color: #4361ee;
                --primary-hover: #3a56d4;
                --secondary-color: #3f37c9;
                --accent-color: #4cc9f0;
                --light-bg: #f8f9fa;
                --dark-bg: #212529;
                --light-text: #f8f9fa;
                --dark-text: #212529;
                --user-msg-bg: #e9ecef;
                --assistant-msg-bg: #d8eefe;
                --transition-speed: 0.3s;
                --border-radius: 0.5rem;
            }

            [data-bs-theme="dark"] {
                --light-bg: #212529;
                --dark-bg: #f8f9fa;
                --light-text: #212529;
                --dark-text: #f8f9fa;
                --user-msg-bg: #3a3f44;
                --assistant-msg-bg: #2b3a55;
            }

            body {
                padding-top: 2rem;
                background-color: var(--light-bg);
                transition: background-color var(--transition-speed);
                min-height: 100vh;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            .app-container {
                max-width: 1000px;
                margin: 0 auto;
            }

            .app-header {
                margin-bottom: 2rem;
                text-align: center;
            }

            .app-title {
                font-weight: 700;
                color: var(--primary-color);
                margin-bottom: 0.5rem;
            }

            .app-subtitle {
                font-weight: 400;
                opacity: 0.8;
                margin-bottom: 2rem;
            }

            .card {
                border-radius: var(--border-radius);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: none;
                transition: all var(--transition-speed);
                margin-bottom: 2rem;
            }

            .card-header {
                border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
                background-color: var(--primary-color);
                color: white;
                font-weight: 600;
                padding: 1rem 1.5rem;
            }

            .card-body {
                padding: 1.5rem;
            }

            .btn-primary {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }

            .btn-primary:hover {
                background-color: var(--primary-hover);
                border-color: var(--primary-hover);
            }

            .btn-success {
                background-color: var(--secondary-color);
                border-color: var(--secondary-color);
            }

            .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
            }

            /* Chat Container Styles */
            #chat-container {
                max-height: 600px;
                height: 60vh;
                overflow-y: auto;
                border: 1px solid #dee2e6;
                border-radius: var(--border-radius);
                padding: 1rem;
                background-color: white;
                margin-bottom: 1rem;
                scroll-behavior: smooth;
            }

            [data-bs-theme="dark"] #chat-container {
                background-color: #2b2b2b;
                border-color: #444;
            }

            .message {
                margin-bottom: 1rem;
                padding: 0.75rem 1rem;
                border-radius: var(--border-radius);
                position: relative;
                max-width: 80%;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                animation: fadeIn 0.3s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .user-message {
                background-color: var(--user-msg-bg);
                text-align: right;
                margin-left: auto;
                border-bottom-right-radius: 0;
            }

            .assistant-message {
                background-color: var(--assistant-msg-bg);
                margin-right: auto;
                border-bottom-left-radius: 0;
            }

            .typing-indicator {
                display: flex;
                align-items: center;
                padding: 0.5rem 1rem;
                background-color: var(--assistant-msg-bg);
                border-radius: var(--border-radius);
                margin-bottom: 1rem;
                max-width: fit-content;
            }

            .typing-indicator span {
                height: 8px;
                width: 8px;
                background-color: #555;
                border-radius: 50%;
                display: inline-block;
                margin: 0 2px;
                animation: typing 1.4s ease-in-out infinite;
            }
            [data-bs-theme="dark"] .typing-indicator span {
                background-color: #bbb;
            }

            .typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes typing {
                0% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-5px);
                }
                100% {
                    transform: translateY(0);
                }
            }

            /* Progress indicator */
            .progress-indicator {
                display: flex;
                justify-content: space-between;
                margin-bottom: 2rem;
                position: relative;
            }

            .progress-indicator::before {
                content: "";
                position: absolute;
                top: 10px;
                left: 0;
                right: 0;
                height: 2px;
                background-color: #dee2e6;
                z-index: 1;
            }
            [data-bs-theme="dark"] .progress-indicator::before {
                background-color: #444;
            }

            .progress-step {
                position: relative;
                z-index: 2;
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 33.33%;
                cursor: default; /* Default cursor */
            }
            .progress-step.clickable {
                cursor: pointer; /* Pointer cursor when clickable */
            }

            .step-icon {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background-color: white;
                border: 2px solid #dee2e6;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                margin-bottom: 0.5rem;
                transition: background-color 0.3s, border-color 0.3s;
            }
            [data-bs-theme="dark"] .step-icon {
                background-color: #333;
                border-color: #555;
                color: #ccc;
            }

            .step-active .step-icon {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
            }
            [data-bs-theme="dark"] .step-active .step-icon {
                color: white;
            }

            .step-complete .step-icon {
                background-color: #198754;
                border-color: #198754;
                color: white;
            }
            [data-bs-theme="dark"] .step-complete .step-icon {
                color: white;
            }

            .step-label {
                font-size: 0.875rem;
                font-weight: 500;
                text-align: center;
            }

            /* Roadmap Styles */
            .roadmap-container {
                position: relative;
            }

            .roadmap-item {
                border-left: 3px solid var(--primary-color);
                padding: 1rem 1.5rem;
                margin-bottom: 1.5rem;
                position: relative;
                transition: all var(--transition-speed);
            }
            [data-bs-theme="dark"] .roadmap-item {
                border-left-color: var(--primary-hover);
            }

            .roadmap-item:hover {
                background-color: rgba(67, 97, 238, 0.05);
                transform: translateX(5px);
            }
            [data-bs-theme="dark"] .roadmap-item:hover {
                background-color: rgba(67, 97, 238, 0.15);
            }

            .roadmap-item::before {
                content: "";
                position: absolute;
                left: -10px;
                top: 15px; /* Adjusted for better alignment */
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background-color: var(--primary-color);
            }
            [data-bs-theme="dark"] .roadmap-item::before {
                background-color: var(--primary-hover);
            }

            .roadmap-item h5 {
                color: var(--primary-color);
                margin-bottom: 0.5rem;
            }
            [data-bs-theme="dark"] .roadmap-item h5 {
                color: var(--accent-color);
            }

            /* Results page */
            .result-section {
                margin-bottom: 2rem;
            }

            .result-section h4 {
                margin-bottom: 1rem;
                border-bottom: 2px solid var(--primary-color);
                padding-bottom: 0.5rem;
                display: inline-block;
            }
            [data-bs-theme="dark"] .result-section h4 {
                border-bottom-color: var(--primary-hover);
            }

            .list-group-item {
                border-left: 3px solid var(--primary-color);
                margin-bottom: 0.5rem;
                border-radius: var(--border-radius);
                background-color: var(
                    --bs-list-group-bg
                ); /* Use Bootstrap variable */
            }
            [data-bs-theme="dark"] .list-group-item {
                border-left-color: var(--primary-hover);
                background-color: #3a3f44; /* Darker list item */
                color: var(--dark-text);
            }

            /* Toggle Switch */
            .theme-switch-wrapper {
                position: absolute;
                top: 1rem;
                right: 1rem;
                display: flex;
                align-items: center;
                z-index: 1050; /* Ensure it's above other elements */
            }

            .theme-switch {
                display: inline-block;
                height: 26px;
                position: relative;
                width: 50px;
            }

            .theme-switch input {
                display: none;
            }

            .slider {
                background-color: #ccc;
                bottom: 0;
                cursor: pointer;
                left: 0;
                position: absolute;
                right: 0;
                top: 0;
                transition: 0.4s;
                border-radius: 34px;
            }

            .slider:before {
                background-color: white;
                bottom: 4px;
                content: "";
                height: 18px;
                left: 4px;
                position: absolute;
                transition: 0.4s;
                width: 18px;
                border-radius: 50%;
            }

            input:checked + .slider {
                background-color: var(--primary-color);
            }

            input:checked + .slider:before {
                transform: translateX(24px);
            }

            .action-buttons {
                display: flex;
                flex-wrap: wrap; /* Allow wrapping on smaller screens */
                gap: 0.5rem;
                margin-top: 1.5rem;
            }

            /* Skills Tree View */
            .tree-view-toggle {
                margin-bottom: 1rem;
            }

            .skills-tree {
                display: none;
                padding: 1rem;
                background-color: #f8f9fa;
                border-radius: var(--border-radius);
                height: 500px;
                position: relative;
                overflow: hidden;
            }

            [data-bs-theme="dark"] .skills-tree {
                background-color: #2b2b2b;
            }

            .node circle {
                /* fill: var(--primary-color); */ /* Color based on proficiency now */
                stroke: #fff;
                stroke-width: 2px;
                filter: drop-shadow(
                    0px 1px 2px rgba(0, 0, 0, 0.2)
                ); /* Added shadow */
            }
            [data-bs-theme="dark"] .node circle {
                stroke: #555;
            }

            .node text {
                font-size: 12px;
                font-family: sans-serif;
                fill: var(--dark-text); /* Use theme text color */
            }
            [data-bs-theme="dark"] .node text {
                fill: var(--light-text);
            }

            .link {
                fill: none;
                /* stroke: #ccc; */ /* Style set in JS */
                /* stroke-width: 1.5px; */ /* Style set in JS */
                /* transition: stroke 0.2s; */ /* Transition removed for stability */
            }
            /* [data-bs-theme="dark"] .link { */
            /* stroke: #555; */ /* Style set in JS */
            /* } */

            .node-tooltip {
                position: absolute;
                background-color: rgba(0, 0, 0, 0.8); /* Darker tooltip */
                color: white;
                padding: 8px 12px; /* Increased padding */
                border-radius: 4px;
                font-size: 12px;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s;
                max-width: 250px; /* Increased max width */
                z-index: 100;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* Added shadow */
            }

            /* Knowledge Graph Styles */
            .knowledge-graph {
                height: 400px;
                background-color: #f8f9fa;
                border-radius: var(--border-radius);
                position: relative;
                overflow: hidden;
                margin-bottom: 2rem;
                border: 1px solid #dee2e6; /* Added subtle border */
            }

            [data-bs-theme="dark"] .knowledge-graph {
                background-color: #2b2b2b;
                border-color: #444;
            }

            .knowledge-node {
                cursor: pointer;
                transition: all 0.2s;
            }

            .knowledge-node:hover {
                /* Handled by JS now */
            }

            .knowledge-list {
                margin-bottom: 2rem;
            }

            .node-proficiency-high {
                fill: #198754;
            }
            .node-proficiency-medium {
                fill: #ffc107;
            } /* Changed to warning yellow */
            .node-proficiency-low {
                fill: #6c757d;
            }

            /* Roadmap Diagram Styles */
            .roadmap-diagram {
                display: none;
                min-height: 400px; /* Ensure minimum height */
                height: auto; /* Allow height to grow */
                background-color: #f8f9fa;
                border-radius: var(--border-radius);
                position: relative;
                overflow: auto; /* Changed to auto for scrolling if needed */
                padding: 2rem;
                border: 1px solid #dee2e6; /* Added subtle border */
            }

            [data-bs-theme="dark"] .roadmap-diagram {
                background-color: #2b2b2b;
                border-color: #444;
            }

            .roadmap-stage {
                margin-bottom: 3rem;
                position: relative;
            }

            .roadmap-stage-title {
                font-weight: 600;
                margin-bottom: 1.5rem; /* Increased spacing */
                color: var(--primary-color);
                border-bottom: 2px solid var(--primary-color);
                display: inline-block;
                padding-bottom: 0.25rem;
            }
            [data-bs-theme="dark"] .roadmap-stage-title {
                color: var(--accent-color);
                border-bottom-color: var(--accent-color);
            }

            .roadmap-stage-items {
                display: flex;
                flex-wrap: wrap;
                gap: 2rem; /* Increased gap */
                margin-bottom: 1.5rem; /* Added bottom margin */
                position: relative; /* Needed for absolute positioning of arrows */
                z-index: 2; /* Ensure nodes are above arrows */
            }

            .roadmap-node {
                width: 220px;
                padding: 1rem;
                border-radius: var(--border-radius);
                background-color: white;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Softer shadow */
                position: relative;
                transition: all 0.3s;
                z-index: 2; /* Ensure nodes are above arrows */
                border: 1px solid #eee; /* Subtle border */
            }

            [data-bs-theme="dark"] .roadmap-node {
                background-color: #424242;
                color: #e0e0e0;
                border-color: #555;
            }

            .roadmap-node:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            }

            .roadmap-node h5 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
                color: var(--primary-color);
            }
            [data-bs-theme="dark"] .roadmap-node h5 {
                color: var(--accent-color);
            }

            .roadmap-node-description {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
                color: #555; /* Slightly darker text */
            }
            [data-bs-theme="dark"] .roadmap-node-description {
                color: #ccc;
            }

            .roadmap-node-prereq {
                font-size: 0.75rem;
                color: #6c757d;
                margin-top: 0.75rem; /* Increased spacing */
                border-top: 1px dashed #eee; /* Separator */
                padding-top: 0.5rem;
            }
            [data-bs-theme="dark"] .roadmap-node-prereq {
                color: #aaa;
                border-top-color: #555;
            }

            .roadmap-arrows {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1; /* Below nodes */
                overflow: visible; /* Ensure arrows aren't clipped */
            }

            .roadmap-arrow {
                fill: none;
                stroke: #adb5bd;
                stroke-width: 1.5px; /* Thinner arrow */
                stroke-opacity: 0.7;
                marker-end: url(#arrowhead);
                transition: stroke-opacity 0.2s;
            }
            [data-bs-theme="dark"] .roadmap-arrow {
                stroke: #666;
            }

            .roadmap-arrow:hover {
                stroke-opacity: 1;
            }

            /* Alert styling */
            .alert-container {
                position: fixed;
                top: 70px; /* Below header */
                left: 50%;
                transform: translateX(-50%);
                z-index: 1055; /* Above most elements */
                width: auto;
                max-width: 90%;
            }
            .alert {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            /* Mobile improvements */
            @media (max-width: 768px) {
                .user-message,
                .assistant-message {
                    max-width: 90%;
                }

                .action-buttons {
                    flex-direction: column;
                    align-items: stretch; /* Make buttons full width */
                }
                .action-buttons .btn {
                    width: 100%; /* Full width buttons on mobile */
                }

                .roadmap-item {
                    padding-left: 1rem;
                    padding-right: 1rem;
                }
                .roadmap-stage-items {
                    flex-direction: column; /* Stack nodes vertically */
                    align-items: center; /* Center nodes */
                }
                .roadmap-node {
                    width: 90%; /* Wider nodes on mobile */
                }
                .progress-indicator {
                    margin-bottom: 1.5rem;
                }
                .step-label {
                    font-size: 0.75rem; /* Smaller labels */
                }
                .theme-switch-wrapper {
                    top: 0.5rem;
                    right: 0.5rem;
                }
                body {
                    padding-top: 1rem;
                }
                .app-title {
                    font-size: 1.75rem;
                }
                .app-subtitle {
                    font-size: 0.9rem;
                    margin-bottom: 1.5rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="theme-switch-wrapper">
            <label class="theme-switch">
                <input type="checkbox" id="theme-toggle" />
                <span class="slider"></span>
            </label>
            <span class="ms-2" id="theme-label">Dark Mode</span>
        </div>

        <!-- Alert Container -->
        <div id="alert-container" class="alert-container"></div>

        <div class="container app-container">
            <div class="app-header">
                <h1 class="app-title">Learning Navigator</h1>
                <p class="app-subtitle">
                    Your AI-powered guide to personalized learning
                </p>
            </div>

            <div class="progress-indicator">
                <div class="progress-step" id="step-setup" data-step="setup">
                    <div class="step-icon">1</div>
                    <div class="step-label">Setup</div>
                </div>
                <div
                    class="progress-step"
                    id="step-diagnostic"
                    data-step="diagnostic"
                >
                    <div class="step-icon">2</div>
                    <div class="step-label">Diagnostic</div>
                </div>
                <div
                    class="progress-step"
                    id="step-results"
                    data-step="results"
                >
                    <div class="step-icon">3</div>
                    <div class="step-label">Results</div>
                </div>
            </div>

            <!-- Setup Section -->
            <div id="setup-form" style="display: none">
                <div class="card">
                    <div
                        class="card-header d-flex justify-content-between align-items-center"
                    >
                        <h3 class="mb-0">Start Your Learning Journey</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="subject" class="form-label"
                                >What subject do you want to learn?</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                id="subject"
                                placeholder="e.g., Mathematics, Physics, Programming"
                            />
                        </div>
                        <div class="mb-3">
                            <label for="goal" class="form-label"
                                >What is your learning goal?</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                id="goal"
                                placeholder="e.g., Pass Grade 8 Math, Learn Python basics"
                            />
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="age" class="form-label"
                                    >Age (optional)</label
                                >
                                <input
                                    type="number"
                                    class="form-control"
                                    id="age"
                                />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="grade" class="form-label"
                                    >Current Grade (optional)</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="grade"
                                />
                            </div>
                        </div>
                        <button id="start-diagnostic" class="btn btn-primary">
                            <i class="bi bi-play-fill"></i> Start Diagnostic
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chat-section" style="display: none">
                <div class="card">
                    <div
                        class="card-header d-flex justify-content-between align-items-center"
                    >
                        <h3 class="mb-0">Diagnostic Assessment</h3>
                        <div>
                            <button
                                id="restart-diagnostic"
                                class="btn btn-outline-light me-2"
                                title="Restart Assessment"
                            >
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <button
                                id="complete-diagnostic"
                                class="btn btn-light text-primary"
                                title="Finish and View Results"
                            >
                                <i class="bi bi-check-circle-fill"></i> Complete
                                Assessment
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="chat-container"></div>

                        <div
                            class="typing-indicator"
                            id="typing-indicator"
                            style="display: none"
                        >
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>

                        <div class="input-group mt-3">
                            <input
                                type="text"
                                id="user-input"
                                class="form-control"
                                placeholder="Type your answer..."
                            />
                            <button id="send-message" class="btn btn-primary">
                                <i class="bi bi-send-fill"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Section -->
            <div id="result-container" style="display: none">
                <div class="card">
                    <div
                        class="card-header d-flex justify-content-between align-items-center"
                    >
                        <h3 class="mb-0">Your Diagnostic Results</h3>
                        <div class="action-buttons-header">
                            <button
                                id="download-pdf"
                                class="btn btn-outline-light"
                                title="Download as PDF (mock)"
                            >
                                <i class="bi bi-download"></i>
                            </button>
                            <button
                                id="share-results"
                                class="btn btn-outline-light"
                                title="Share Results (mock)"
                            >
                                <i class="bi bi-share"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i> Your
                            assessment is complete! Explore your personalized
                            results below.
                        </div>

                        <div class="result-section">
                            <h4>Your Knowledge</h4>
                            <div class="knowledge-view-toggle mb-3">
                                <div class="btn-group" role="group">
                                    <button
                                        type="button"
                                        class="btn btn-primary active"
                                        id="knowledge-graph-btn"
                                    >
                                        Knowledge Map
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        id="knowledge-list-btn"
                                    >
                                        List View
                                    </button>
                                </div>
                            </div>
                            <div
                                id="knowledge-graph"
                                class="knowledge-graph"
                            ></div>
                            <div
                                id="knowledge-list"
                                class="knowledge-list"
                                style="display: none"
                            ></div>
                        </div>

                        <div class="row result-section">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <!-- Added margin bottom for mobile -->
                                <h4>Your Strengths</h4>
                                <ul id="strengths-list" class="list-group"></ul>
                            </div>
                            <div class="col-md-6">
                                <h4>Areas to Improve</h4>
                                <ul id="gaps-list" class="list-group"></ul>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Your Personalized Learning Roadmap</h4>

                            <div class="tree-view-toggle">
                                <div class="btn-group" role="group">
                                    <button
                                        type="button"
                                        class="btn btn-primary active"
                                        id="list-view-btn"
                                    >
                                        List View
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        id="diagram-view-btn"
                                    >
                                        Diagram View
                                    </button>
                                </div>
                            </div>

                            <div
                                id="roadmap-container"
                                class="roadmap-container mt-3"
                                <!--
                                Added
                                margin
                                top
                                --
                            >
                                >
                            </div>
                            <div
                                id="roadmap-diagram"
                                class="roadmap-diagram mt-3"
                                <!--
                                Added
                                margin
                                top
                                --
                            >
                                >
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Recommendations</h4>
                            <ul
                                id="recommendations-list"
                                class="list-group"
                            ></ul>
                        </div>

                        <div class="result-section">
                            <h4>Your Interests</h4>
                            <p
                                id="interests-display"
                                class="p-3 rounded border"
                            ></p>
                        </div>

                        <div class="action-buttons">
                            <button
                                id="download-roadmap"
                                class="btn btn-primary"
                            >
                                <i class="bi bi-download"></i> Download Results
                                (JSON)
                            </button>
                            <button
                                id="print-roadmap"
                                class="btn btn-outline-primary"
                            >
                                <i class="bi bi-printer"></i> Print Page
                            </button>
                            <button
                                id="new-assessment"
                                class="btn btn-outline-secondary"
                            >
                                <i class="bi bi-plus-circle"></i> Start New
                                Assessment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // --- Global State Variables ---
            let sessionId = null;
            let diagnosticResults = null;
            let setupData = { subject: "", goal: "", age: "", grade: "" };
            let chatHistory = []; // Stores { role: 'user'/'assistant', content: '...' }
            let isDiagnosticComplete = false;
            let currentStage = "setup"; // 'setup', 'diagnostic', 'results'

            // --- DOM Elements ---
            const setupForm = document.getElementById("setup-form");
            const chatSection = document.getElementById("chat-section");
            const resultContainer = document.getElementById("result-container");
            const chatContainer = document.getElementById("chat-container");
            const userInput = document.getElementById("user-input");
            const sendMessageBtn = document.getElementById("send-message");
            const typingIndicator = document.getElementById("typing-indicator");
            const startDiagnosticBtn =
                document.getElementById("start-diagnostic");
            const completeDiagnosticBtn = document.getElementById(
                "complete-diagnostic"
            );
            const restartDiagnosticBtn =
                document.getElementById("restart-diagnostic");
            const newAssessmentBtn = document.getElementById("new-assessment");
            const themeToggle = document.getElementById("theme-toggle");
            const themeLabel = document.getElementById("theme-label");
            const alertContainer = document.getElementById("alert-container");

            // --- Initialization ---
            document.addEventListener("DOMContentLoaded", () => {
                // Set initial theme based on preference or default
                const prefersDark =
                    window.matchMedia &&
                    window.matchMedia("(prefers-color-scheme: dark)").matches;
                if (
                    localStorage.getItem("theme") === "dark" ||
                    (!localStorage.getItem("theme") && prefersDark)
                ) {
                    themeToggle.checked = true;
                    document.documentElement.setAttribute(
                        "data-bs-theme",
                        "dark"
                    );
                    themeLabel.textContent = "Light Mode";
                } else {
                    document.documentElement.setAttribute(
                        "data-bs-theme",
                        "light"
                    );
                    themeLabel.textContent = "Dark Mode";
                }

                // Initialize view
                navigateToStage("setup");
                setupProgressStepClickHandlers(); // Add click handlers for steps
            });

            // --- Theme Switcher ---
            themeToggle.addEventListener("change", function () {
                if (this.checked) {
                    document.documentElement.setAttribute(
                        "data-bs-theme",
                        "dark"
                    );
                    themeLabel.textContent = "Light Mode";
                    localStorage.setItem("theme", "dark");
                } else {
                    document.documentElement.setAttribute(
                        "data-bs-theme",
                        "light"
                    );
                    themeLabel.textContent = "Dark Mode";
                    localStorage.setItem("theme", "light");
                }
                // Re-render graphs if visible, as colors might change
                if (currentStage === "results" && diagnosticResults) {
                    if (
                        document.getElementById("knowledge-graph").style
                            .display !== "none"
                    ) {
                        createKnowledgeGraph(diagnosticResults.knowledge_graph);
                    }
                    if (
                        document.getElementById("roadmap-diagram").style
                            .display !== "none"
                    ) {
                        createRoadmapDiagram(
                            diagnosticResults.learning_roadmap
                        );
                    }
                }
            });

            // --- Navigation Logic ---

            function navigateToStage(stageName) {
                console.log(`Navigating to stage: ${stageName}`);
                currentStage = stageName;

                // Hide all sections first
                setupForm.style.display = "none";
                chatSection.style.display = "none";
                resultContainer.style.display = "none";

                // Show the target section and populate it
                switch (stageName) {
                    case "setup":
                        setupForm.style.display = "block";
                        populateSetupForm();
                        // Disable start button if diagnostic already started
                        startDiagnosticBtn.disabled = !!sessionId;
                        break;
                    case "diagnostic":
                        chatSection.style.display = "block";
                        rebuildChatHistory();
                        // Disable input if diagnostic is complete
                        userInput.disabled = isDiagnosticComplete;
                        sendMessageBtn.disabled = isDiagnosticComplete;
                        completeDiagnosticBtn.disabled = isDiagnosticComplete; // Also disable complete button if already done
                        // Scroll to bottom
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        break;
                    case "results":
                        resultContainer.style.display = "block";
                        if (diagnosticResults) {
                            displayResults(diagnosticResults); // Assumes results are loaded
                        } else {
                            // Handle case where results aren't loaded yet (e.g., direct navigation attempt)
                            console.warn(
                                "Attempted to navigate to results, but no results data found."
                            );
                            // Optionally show a loading state or redirect back
                            showAlert(
                                "Diagnostic results not yet available.",
                                "warning"
                            );
                            navigateToStage("diagnostic"); // Go back to diagnostic
                            return; // Prevent progress update below if redirecting
                        }
                        break;
                }
                updateProgressSteps(stageName);
            }

            function populateSetupForm() {
                document.getElementById("subject").value = setupData.subject;
                document.getElementById("goal").value = setupData.goal;
                document.getElementById("age").value = setupData.age;
                document.getElementById("grade").value = setupData.grade;
            }

            function rebuildChatHistory() {
                chatContainer.innerHTML = ""; // Clear existing messages
                chatHistory.forEach((msg) => {
                    // Use the existing addMessage function, but prevent adding to history again
                    addMessage(msg.role, msg.content, false);
                });
                // Ensure typing indicator is hidden when rebuilding
                hideTypingIndicator();
            }

            // --- Progress Steps ---
            function updateProgressSteps(currentStep) {
                const steps = ["setup", "diagnostic", "results"];
                let completed = true; // Flag to track if prior steps are complete

                steps.forEach((step, index) => {
                    const stepElement = document.getElementById(`step-${step}`);
                    stepElement.classList.remove(
                        "step-active",
                        "step-complete",
                        "clickable"
                    );

                    if (step === currentStep) {
                        stepElement.classList.add("step-active");
                        stepElement.classList.add("clickable"); // Current step is clickable
                        completed = false; // Steps after this one are not completed yet
                    } else if (completed) {
                        stepElement.classList.add("step-complete");
                        stepElement.classList.add("clickable"); // Completed steps are clickable
                    }
                });
            }

            function setupProgressStepClickHandlers() {
                document
                    .querySelectorAll(".progress-step")
                    .forEach((stepElement) => {
                        stepElement.addEventListener("click", () => {
                            const stage = stepElement.dataset.step;
                            let canNavigate = false;

                            // Determine if navigation to the clicked stage is allowed based on app state
                            switch (stage) {
                                case "setup":
                                    canNavigate = true; // Always allow going back to setup
                                    break;
                                case "diagnostic":
                                    // Allow if diagnostic has been started (sessionId exists)
                                    canNavigate = !!sessionId;
                                    break;
                                case "results":
                                    // Allow if diagnostic is complete AND results are loaded
                                    canNavigate =
                                        isDiagnosticComplete &&
                                        !!diagnosticResults;
                                    break;
                            }

                            if (canNavigate) {
                                // Add a specific check: Even if marked complete, don't go to results if data isn't loaded
                                if (stage === "results" && !diagnosticResults) {
                                    console.warn(
                                        "Attempted to navigate to results stage, but results data is not ready."
                                    );
                                    showAlert(
                                        "Results are not yet available. Please wait or complete the diagnostic first.",
                                        "warning"
                                    );
                                    return; // Stop navigation
                                }
                                // Navigate if allowed
                                navigateToStage(stage);
                            } else {
                                // Provide feedback if navigation is not allowed yet
                                console.log(
                                    `Stage ${stage} is not yet reachable.`
                                );
                                let message =
                                    "Please complete the current step first.";
                                if (stage === "diagnostic" && !sessionId) {
                                    message =
                                        "Please start the diagnostic from the Setup page first.";
                                } else if (
                                    stage === "results" &&
                                    !isDiagnosticComplete
                                ) {
                                    message =
                                        "Please complete the diagnostic assessment first.";
                                }
                                showAlert(message, "info");
                            }
                        });
                    });
            }

            // --- Event Listeners ---

            // Start Diagnostic Button
            startDiagnosticBtn.addEventListener("click", function () {
                setupData.subject = document
                    .getElementById("subject")
                    .value.trim();
                setupData.goal = document.getElementById("goal").value.trim();
                setupData.age = document.getElementById("age").value.trim();
                setupData.grade = document.getElementById("grade").value.trim();

                if (!setupData.subject || !setupData.goal) {
                    showAlert("Please enter both subject and goal", "warning");
                    return;
                }

                // Reset state for a potentially new diagnostic run (if user went back and restarted)
                resetChatState();
                isDiagnosticComplete = false; // Ensure it's not marked complete

                navigateToStage("diagnostic"); // Move to chat view first
                showTypingIndicator(); // Show indicator immediately

                fetch("/api/start-diagnostic", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(setupData),
                })
                    .then(handleFetchResponse)
                    .then((data) => {
                        sessionId = data.session_id;
                        hideTypingIndicator();
                        addMessage("assistant", data.message);
                        startDiagnosticBtn.disabled = true; // Disable after starting
                    })
                    .catch((error) => {
                        hideTypingIndicator();
                        console.error("Error starting diagnostic:", error);
                        showAlert(
                            `Error: ${
                                error.message ||
                                "Failed to start diagnostic session"
                            }`,
                            "danger"
                        );
                        navigateToStage("setup"); // Go back to setup on error
                    });
            });

            // Send Message Button & Enter Key
            sendMessageBtn.addEventListener("click", handleSendMessage);
            userInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter" && !sendMessageBtn.disabled) {
                    handleSendMessage();
                }
            });

            function handleSendMessage() {
                if (!sessionId || isDiagnosticComplete) return;

                const messageText = userInput.value.trim();
                if (!messageText) return;

                addMessage("user", messageText);
                userInput.value = "";
                showTypingIndicator();
                userInput.disabled = true; // Disable input while waiting
                sendMessageBtn.disabled = true;

                fetch("/api/continue-diagnostic", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: messageText,
                    }),
                })
                    .then(handleFetchResponse)
                    .then((data) => {
                        hideTypingIndicator();
                        addMessage("assistant", data.message);
                        // Re-enable input if diagnostic is not complete
                        if (!isDiagnosticComplete) {
                            userInput.disabled = false;
                            sendMessageBtn.disabled = false;
                            userInput.focus(); // Focus back on input
                        }
                        // Note: The backend's 'is_complete' isn't used here; completion is explicit via button.
                    })
                    .catch((error) => {
                        hideTypingIndicator();
                        console.error("Error continuing diagnostic:", error);
                        showAlert(
                            `Error: ${
                                error.message || "Failed to send message"
                            }`,
                            "danger"
                        );
                        // Re-enable input on error if not complete
                        if (!isDiagnosticComplete) {
                            userInput.disabled = false;
                            sendMessageBtn.disabled = false;
                        }
                    });
            }

            // Complete Diagnostic Button
            completeDiagnosticBtn.addEventListener("click", function () {
                if (!sessionId || isDiagnosticComplete) return;

                if (
                    !confirm(
                        "Are you sure you want to complete the assessment and view your results? You won't be able to ask more questions."
                    )
                ) {
                    return;
                }

                showTypingIndicator();
                userInput.disabled = true; // Disable input permanently now
                sendMessageBtn.disabled = true;
                completeDiagnosticBtn.disabled = true; // Disable complete button

                fetch("/api/complete-diagnostic", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ session_id: sessionId }),
                })
                    .then(handleFetchResponse)
                    .then((data) => {
                        hideTypingIndicator();
                        diagnosticResults = data.diagnostic_result;
                        isDiagnosticComplete = true; // Mark as complete
                        navigateToStage("results"); // Navigate to results page
                    })
                    .catch((error) => {
                        hideTypingIndicator();
                        console.error("Error completing diagnostic:", error);
                        showAlert(
                            `Error: ${
                                error.message || "Failed to generate results"
                            }`,
                            "danger"
                        );
                        // Re-enable complete button on error, but keep input disabled
                        completeDiagnosticBtn.disabled = false;
                    });
            });

            // Restart Diagnostic Button
            restartDiagnosticBtn.addEventListener("click", function () {
                if (
                    confirm(
                        "Are you sure you want to restart the diagnostic? All progress will be lost."
                    )
                ) {
                    resetAppState();
                    navigateToStage("setup");
                }
            });

            // New Assessment Button (on results page)
            newAssessmentBtn.addEventListener("click", function () {
                if (confirm("Start a completely new assessment?")) {
                    resetAppState();
                    navigateToStage("setup");
                }
            });

            // --- Chat Helpers ---
            function addMessage(role, content, addToHistory = true) {
                if (addToHistory) {
                    chatHistory.push({ role, content });
                }

                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${role}-message`;
                // Sanitize content before parsing? Marked generally handles basic XSS, but be cautious.
                messageDiv.innerHTML = marked.parse(
                    content || "*No content received*"
                ); // Handle potential null/empty content

                chatContainer.appendChild(messageDiv);
                // Scroll to bottom smoothly
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: "smooth",
                });
            }

            function showTypingIndicator() {
                typingIndicator.style.display = "flex";
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function hideTypingIndicator() {
                typingIndicator.style.display = "none";
            }

            // --- Result Display Logic ---
            function displayResults(results) {
                if (!results) {
                    showAlert("No diagnostic results to display.", "warning");
                    return;
                }
                console.log("Displaying results:", results);

                // Populate strengths
                const strengthsList = document.getElementById("strengths-list");
                strengthsList.innerHTML =
                    results.diagnostic_summary?.strengths?.length > 0
                        ? results.diagnostic_summary.strengths
                              .map(
                                  (s) =>
                                      `<li class="list-group-item">${marked.parseInline(
                                          s || "" // Handle potential null/undefined strength
                                      )}</li>`
                              )
                              .join("")
                        : '<li class="list-group-item text-muted">No specific strengths identified.</li>';

                // Populate gaps
                const gapsList = document.getElementById("gaps-list");
                gapsList.innerHTML =
                    results.diagnostic_summary?.gaps?.length > 0
                        ? results.diagnostic_summary.gaps
                              .map(
                                  (g) =>
                                      `<li class="list-group-item">${marked.parseInline(
                                          g || "" // Handle potential null/undefined gap
                                      )}</li>`
                              )
                              .join("")
                        : '<li class="list-group-item text-muted">No specific areas for improvement identified.</li>';

                // Create Knowledge Graph & List (handle potential missing data)
                if (results.knowledge_graph && results.knowledge_graph.nodes) {
                    createKnowledgeGraph(results.knowledge_graph);
                    createKnowledgeList(results.knowledge_graph);
                    // Ensure correct view is shown initially
                    document.getElementById("knowledge-graph").style.display =
                        "block";
                    document.getElementById("knowledge-list").style.display =
                        "none";
                    document
                        .getElementById("knowledge-graph-btn")
                        .classList.add("active", "btn-primary");
                    document
                        .getElementById("knowledge-graph-btn")
                        .classList.remove("btn-outline-primary");
                    document
                        .getElementById("knowledge-list-btn")
                        .classList.remove("active", "btn-primary");
                    document
                        .getElementById("knowledge-list-btn")
                        .classList.add("btn-outline-primary");
                } else {
                    document.getElementById("knowledge-graph").innerHTML =
                        '<p class="text-center text-muted p-3">Knowledge map data not available.</p>';
                    document.getElementById("knowledge-list").innerHTML =
                        '<p class="text-center text-muted p-3">Knowledge list data not available.</p>';
                }

                // Populate roadmap list view
                const roadmapContainer =
                    document.getElementById("roadmap-container");
                if (
                    results.learning_roadmap &&
                    results.learning_roadmap.length > 0
                ) {
                    roadmapContainer.innerHTML = results.learning_roadmap
                        .map(
                            (item, index) => `
                        <div class="roadmap-item" data-id="${
                            item.id || `roadmap-item-${index}`
                        }"> <!-- Ensure unique ID -->
                            <h5>${index + 1}. ${marked.parseInline(
                                item.concept || "Unnamed Step"
                            )}</h5>
                            <p>${marked.parseInline(item.description || "")}</p>
                            <p class="mb-1"><strong>Prerequisites:</strong> ${
                                item.prerequisites?.join(", ") || "None"
                            }</p>
                            <p><strong>Suggested Resources:</strong> ${
                                item.resources?.join(", ") || "General study"
                            }</p>
                        </div>
                    `
                        )
                        .join("");

                    // Create Roadmap Diagram View
                    createRoadmapDiagram(results.learning_roadmap);
                    // Ensure correct view is shown initially
                    document.getElementById("roadmap-container").style.display =
                        "block";
                    document.getElementById("roadmap-diagram").style.display =
                        "none";
                    document
                        .getElementById("list-view-btn")
                        .classList.add("active", "btn-primary");
                    document
                        .getElementById("list-view-btn")
                        .classList.remove("btn-outline-primary");
                    document
                        .getElementById("diagram-view-btn")
                        .classList.remove("active", "btn-primary");
                    document
                        .getElementById("diagram-view-btn")
                        .classList.add("btn-outline-primary");
                } else {
                    roadmapContainer.innerHTML =
                        '<p class="text-center text-muted p-3">Learning roadmap not available.</p>';
                    document.getElementById("roadmap-diagram").innerHTML =
                        '<p class="text-center text-muted p-3">Roadmap diagram not available.</p>';
                }

                // Populate recommendations
                const recommendationsList = document.getElementById(
                    "recommendations-list"
                );
                recommendationsList.innerHTML =
                    results.recommendations?.length > 0
                        ? results.recommendations
                              .map(
                                  (r) =>
                                      `<li class="list-group-item">${marked.parse(
                                          r || "" // Handle potential null/undefined recommendation
                                      )}</li>`
                              )
                              .join("")
                        : '<li class="list-group-item text-muted">No specific recommendations provided.</li>';

                // Populate interests
                document.getElementById("interests-display").textContent =
                    results.user_interests?.join(", ") ||
                    "No specific interests recorded.";

                // Ensure chat is disabled (might be redundant, but safe)
                userInput.disabled = true;
                sendMessageBtn.disabled = true;
                completeDiagnosticBtn.disabled = true;
            }

            // --- d3 Visualizations (Knowledge Graph & Roadmap Diagram) ---

            function createKnowledgeGraph(knowledgeData) {
                const graphContainer = d3.select("#knowledge-graph");
                graphContainer.html(""); // Clear previous graph

                if (
                    !knowledgeData ||
                    !knowledgeData.nodes ||
                    knowledgeData.nodes.length === 0
                ) {
                    graphContainer
                        .append("div")
                        .attr("class", "text-center text-muted py-5")
                        .text("No knowledge data available for map view.");
                    return;
                }
                console.log("Creating knowledge graph..."); // Debug log

                const tooltip = graphContainer
                    .append("div")
                    .attr("class", "node-tooltip")
                    .style("opacity", 0);

                const width = graphContainer
                    .node()
                    .getBoundingClientRect().width;
                const height = 400; // Fixed height

                const svg = graphContainer
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height]) // Responsive viewBox
                    .style("max-width", "100%")
                    .style("height", "auto");

                const g = svg.append("g");

                const zoom = d3
                    .zoom()
                    .scaleExtent([0.3, 4]) // Wider zoom range
                    .on("zoom", (event) => {
                        g.attr("transform", event.transform);
                        // Adjust stroke width on zoom for better visibility
                        g.selectAll("circle").attr(
                            "stroke-width",
                            2 / event.transform.k
                        );
                        g.selectAll(".link").attr(
                            "stroke-width",
                            1.5 / event.transform.k
                        );
                    });

                svg.call(zoom);

                // Filter out links with missing source/target nodes (robustness)
                const nodeIds = new Set(knowledgeData.nodes.map((n) => n.id));
                const validLinks = (knowledgeData.links || []).filter(
                    (link) =>
                        nodeIds.has(link.source) && nodeIds.has(link.target)
                );
                console.log(
                    `Found ${knowledgeData.nodes.length} nodes, ${validLinks.length} valid links.`
                ); // Debug log

                const simulation = d3
                    .forceSimulation(knowledgeData.nodes)
                    .force(
                        "link",
                        d3
                            .forceLink(validLinks)
                            .id((d) => d.id)
                            .distance(100)
                            .strength(0.5)
                    ) // Adjusted link force
                    .force("charge", d3.forceManyBody().strength(-350)) // Slightly weaker charge
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("x", d3.forceX(width / 2).strength(0.05)) // Weaker positioning force
                    .force("y", d3.forceY(height / 2).strength(0.05))
                    .force("collision", d3.forceCollide().radius(30)); // Collision radius

                svg.append("defs")
                    .append("marker")
                    .attr("id", "knowledge-arrow")
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 25) // Adjusted for node size + gap
                    .attr("refY", 0)
                    .attr("markerWidth", 5)
                    .attr("markerHeight", 5)
                    .attr("orient", "auto")
                    .append("path")
                    .attr("d", "M0,-5L10,0L0,5")
                    .attr("fill", "#999"); // Initial fill, updated in resetHighlighting

                const link = g
                    .append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(validLinks)
                    .join("line")
                    .attr("class", "link")
                    .attr("marker-end", "url(#knowledge-arrow)")
                    .attr("stroke-dasharray", (d) =>
                        d.relationship === "relates_to" ? "4,4" : "none"
                    );

                const node = g
                    .append("g")
                    .attr("class", "nodes")
                    .selectAll(".node")
                    .data(knowledgeData.nodes)
                    .join("g")
                    .attr("class", "node knowledge-node")
                    .call(drag(simulation));

                node.append("circle")
                    .attr("r", 14) // Slightly larger radius
                    .attr(
                        "class",
                        (d) => `node-proficiency-${d.proficiency || "low"}`
                    ) // Default to low if missing
                    .on("mouseover", function (event, d) {
                        tooltip
                            .transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        tooltip.html(`
                            <strong>${d.name || "Unnamed"}</strong><br>
                            ${d.description || "No description."}<br>
                            <em>Proficiency: ${d.proficiency || "Unknown"}</em>
                        `);
                        // Position tooltip relative to the container, not the circle
                        const [x, y] = d3.pointer(event, graphContainer.node());
                        tooltip
                            .style("left", x + 15 + "px")
                            .style("top", y - 28 + "px");

                        // Highlight connected nodes/links
                        highlightConnections(d, node, link, svg); // Pass svg
                    })
                    .on("mouseout", function () {
                        tooltip.transition().duration(300).style("opacity", 0);
                        // Reset highlighting
                        resetHighlighting(node, link, svg); // Pass svg
                    });

                node.append("text")
                    .attr("dx", 18) // Adjusted offset
                    .attr("dy", ".35em")
                    .attr("font-size", "11px") // Slightly smaller text
                    .text((d) => d.name || "Unnamed");

                simulation.on("tick", () => {
                    link.attr("x1", (d) => d.source.x)
                        .attr("y1", (d) => d.source.y)
                        .attr("x2", (d) => d.target.x)
                        .attr("y2", (d) => d.target.y);

                    node.attr("transform", (d) => `translate(${d.x},${d.y})`);
                });

                // Call resetHighlighting AFTER simulation setup and tick handler attachment
                resetHighlighting(node, link, svg);

                // Drag functions (nested for encapsulation)
                function drag(simulation) {
                    function dragstarted(event, d) {
                        if (!event.active)
                            simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    }
                    function dragged(event, d) {
                        d.fx = event.x;
                        d.fy = event.y;
                    }
                    function dragended(event, d) {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null; // Let simulation take over again
                        d.fy = null;
                    }
                    return d3
                        .drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended);
                }

                // Highlighting functions (nested for encapsulation)
                function highlightConnections(
                    selectedNode,
                    allNodes,
                    allLinks,
                    svg // Pass svg to get zoom transform
                ) {
                    const connectedNodeIds = new Set();
                    connectedNodeIds.add(selectedNode.id);
                    const currentZoom = d3.zoomTransform(svg.node()).k || 1;

                    allLinks.each(function (l) {
                        const linkElement = d3.select(this);
                        const sourceId =
                            typeof l.source === "object"
                                ? l.source.id
                                : l.source;
                        const targetId =
                            typeof l.target === "object"
                                ? l.target.id
                                : l.target;

                        if (
                            sourceId === selectedNode.id ||
                            targetId === selectedNode.id
                        ) {
                            linkElement
                                .transition()
                                .duration(150)
                                .attr("stroke", "#f00") // Highlight color
                                .attr("stroke-opacity", 1)
                                .attr("stroke-width", 2 / currentZoom); // Adjust width based on zoom
                            connectedNodeIds.add(sourceId);
                            connectedNodeIds.add(targetId);
                        } else {
                            linkElement
                                .transition()
                                .duration(150)
                                .attr("stroke-opacity", 0.2); // Fade others
                        }
                    });

                    allNodes.each(function (n) {
                        const nodeElement = d3.select(this);
                        nodeElement
                            .transition()
                            .duration(150)
                            .style(
                                "opacity",
                                connectedNodeIds.has(n.id) ? 1 : 0.3
                            ); // Fade non-connected nodes
                    });
                }

                function resetHighlighting(allNodes, allLinks, svg) {
                    // Pass svg
                    const currentZoom = d3.zoomTransform(svg.node()).k || 1;
                    const isDark =
                        document.documentElement.getAttribute(
                            "data-bs-theme"
                        ) === "dark";
                    const linkColor = isDark ? "#555" : "#ccc";
                    const markerColor = isDark ? "#666" : "#999"; // Adjust marker color too

                    allNodes.transition().duration(200).style("opacity", 1); // Reset node opacity

                    // *** FIX: Apply styles directly without transition for links ***
                    allLinks //.transition().duration(200) // REMOVED transition
                        .attr("stroke", linkColor)
                        .attr("stroke-opacity", 0.7)
                        .attr("stroke-width", 1.5 / currentZoom); // Reset link style directly

                    // Update marker color based on theme
                    svg.select("#knowledge-arrow path").attr(
                        "fill",
                        markerColor
                    );
                }
            }

            function createKnowledgeList(knowledgeData) {
                const knowledgeList = document.getElementById("knowledge-list");
                knowledgeList.innerHTML = "";

                if (
                    !knowledgeData ||
                    !knowledgeData.nodes ||
                    knowledgeData.nodes.length === 0
                ) {
                    knowledgeList.innerHTML =
                        "<p class='text-center text-muted py-3'>No knowledge data available for list view.</p>";
                    return;
                }

                const proficiencyGroups = {
                    high: [],
                    medium: [],
                    low: [],
                    unknown: [],
                };
                knowledgeData.nodes.forEach((node) => {
                    (
                        proficiencyGroups[node.proficiency] ||
                        proficiencyGroups.unknown
                    ).push(node);
                });

                const createSection = (title, items) => {
                    if (items.length === 0) return "";
                    return `
                        <div class="mb-3">
                            <h5>${title}</h5>
                            <ul class="list-group">
                                ${items
                                    .map(
                                        (item) => `
                                    <li class="list-group-item">
                                        <strong>${marked.parseInline(
                                            item.name || "Unnamed"
                                        )}</strong>
                                        <p class="mb-0 mt-1" style="font-size: 0.875rem;">${marked.parseInline(
                                            item.description ||
                                                "No description."
                                        )}</p>
                                    </li>
                                `
                                    )
                                    .join("")}
                            </ul>
                        </div>
                    `;
                };

                knowledgeList.innerHTML =
                    createSection("Strong Knowledge", proficiencyGroups.high) +
                    createSection("Familiar", proficiencyGroups.medium) +
                    createSection(
                        "Basic Understanding / Needs Review",
                        proficiencyGroups.low
                    ) +
                    createSection(
                        "Proficiency Not Assessed",
                        proficiencyGroups.unknown
                    );
            }

            function createRoadmapDiagram(roadmapData) {
                const container = document.getElementById("roadmap-diagram");
                container.innerHTML = ""; // Clear previous diagram

                if (!roadmapData || roadmapData.length === 0) {
                    container.innerHTML =
                        "<p class='text-center text-muted py-5'>No roadmap data available for diagram view.</p>";
                    return;
                }
                console.log("Creating roadmap diagram..."); // Debug log

                // Ensure unique IDs and group by stage
                const stageGroups = {
                    beginner: [],
                    intermediate: [],
                    advanced: [],
                    other: [],
                };
                const conceptToIdMap = {};
                let idCounter = 0;

                roadmapData.forEach((item, index) => {
                    // Assign unique ID if missing or duplicate concept name
                    if (!item.id || conceptToIdMap[item.concept]) {
                        item.id = `roadmap-node-${
                            item.concept
                                ? item.concept.replace(/\s+/g, "-")
                                : ""
                        }-${idCounter++}`;
                    }
                    // Ensure ID is valid for DOM querySelector
                    item.id = item.id.replace(/[^a-zA-Z0-9-_]/g, "_"); // Sanitize ID
                    conceptToIdMap[item.concept] = item.id;

                    const stage = item.stage?.toLowerCase() || "other";
                    (stageGroups[stage] || stageGroups.other).push(item);
                });

                // Create container for SVG arrows
                const arrowsContainer = document.createElement("div");
                arrowsContainer.className = "roadmap-arrows";
                const arrowsSvg = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "svg"
                );
                arrowsContainer.appendChild(arrowsSvg);

                // Define arrow marker
                const defs = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "defs"
                );
                const marker = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "marker"
                );
                marker.setAttribute("id", "arrowhead");
                marker.setAttribute("viewBox", "0 -5 10 10");
                marker.setAttribute("refX", "8"); // Adjust for arrow size/stroke
                marker.setAttribute("refY", "0");
                marker.setAttribute("markerWidth", "5"); // Smaller marker
                marker.setAttribute("markerHeight", "5");
                marker.setAttribute("orient", "auto-start-reverse"); // Ensures arrow points correctly
                const pathMarker = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "path"
                );
                pathMarker.setAttribute("d", "M0,-5L10,0L0,5");
                // pathMarker.setAttribute("fill", "#adb5bd"); // Color set in drawRoadmapConnections
                marker.appendChild(pathMarker);
                defs.appendChild(marker);
                arrowsSvg.appendChild(defs);

                // Create stage sections
                const stageOrder = [
                    "beginner",
                    "intermediate",
                    "advanced",
                    "other",
                ];
                stageOrder.forEach((stageKey) => {
                    const group = stageGroups[stageKey];
                    if (group.length > 0) {
                        const stageSection = document.createElement("div");
                        stageSection.className = "roadmap-stage";
                        stageSection.dataset.stage = stageKey;

                        const stageTitle = document.createElement("h5");
                        stageTitle.className = "roadmap-stage-title";
                        // Capitalize first letter for display
                        stageTitle.textContent =
                            stageKey.charAt(0).toUpperCase() +
                            stageKey.slice(1);
                        stageSection.appendChild(stageTitle);

                        const stageItems = document.createElement("div");
                        stageItems.className = "roadmap-stage-items";

                        group.forEach((item) => {
                            const itemNode = document.createElement("div");
                            itemNode.className = "roadmap-node";
                            itemNode.id = item.id; // Use the assigned/sanitized unique ID

                            itemNode.innerHTML = `
                                <h5>${marked.parseInline(
                                    item.concept || "Unnamed Step"
                                )}</h5>
                                <div class="roadmap-node-description">${marked.parseInline(
                                    item.description || ""
                                )}</div>
                                ${
                                    item.prerequisites &&
                                    item.prerequisites.length > 0
                                        ? `
                                <div class="roadmap-node-prereq">
                                    <strong>Prerequisites:</strong> ${item.prerequisites.join(
                                        ", "
                                    )}
                                </div>`
                                        : ""
                                }
                            `;
                            stageItems.appendChild(itemNode);
                        });
                        stageSection.appendChild(stageItems);
                        container.appendChild(stageSection);
                    }
                });

                // Append arrows container at the end, but it will be positioned absolutely
                container.appendChild(arrowsContainer);

                // Draw connections after elements are rendered and layout is calculated
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        drawRoadmapConnections(
                            roadmapData,
                            arrowsSvg,
                            conceptToIdMap
                        );
                    }, 100); // Increased delay slightly
                });
            }

            function drawRoadmapConnections(roadmapData, svg, conceptToIdMap) {
                // Clear only paths, keep defs
                d3.select(svg).selectAll("path:not(defs path)").remove();

                // Ensure the container and SVG have dimensions
                const container = svg.parentElement.parentElement; // The .roadmap-diagram container
                const containerRect = container.getBoundingClientRect();

                if (containerRect.width === 0 || containerRect.height === 0) {
                    console.warn(
                        "Roadmap container has no dimensions, cannot draw arrows yet."
                    );
                    return; // Wait for layout
                }

                // Set SVG dimensions to match container scroll size for absolute positioning
                svg.setAttribute("width", container.scrollWidth);
                svg.setAttribute("height", container.scrollHeight);

                const isDark =
                    document.documentElement.getAttribute("data-bs-theme") ===
                    "dark";
                const arrowColor = isDark ? "#666" : "#adb5bd";
                d3.select(svg)
                    .select("#arrowhead path")
                    .attr("fill", arrowColor); // Set marker color

                roadmapData.forEach((item) => {
                    if (item.prerequisites && item.prerequisites.length > 0) {
                        const targetElement = document.getElementById(item.id);
                        if (!targetElement) {
                            console.warn(
                                `Target element not found for ID: ${item.id}`
                            );
                            return;
                        }
                        const targetRect =
                            targetElement.getBoundingClientRect();

                        item.prerequisites.forEach((prereqConcept) => {
                            const sourceId = conceptToIdMap[prereqConcept];
                            if (!sourceId) {
                                console.warn(
                                    `Source ID not found for prerequisite concept: ${prereqConcept}`
                                );
                                return;
                            }
                            const sourceElement =
                                document.getElementById(sourceId);
                            if (!sourceElement) {
                                console.warn(
                                    `Source element not found for ID: ${sourceId}`
                                );
                                return;
                            }
                            const sourceRect =
                                sourceElement.getBoundingClientRect();

                            // Calculate positions relative to the SVG container's top-left corner
                            // Adjust for container's scroll position
                            const startX =
                                sourceRect.left +
                                sourceRect.width / 2 -
                                containerRect.left +
                                container.scrollLeft;
                            const startY =
                                sourceRect.bottom -
                                containerRect.top +
                                container.scrollTop; // From bottom center of source
                            const endX =
                                targetRect.left +
                                targetRect.width / 2 -
                                containerRect.left +
                                container.scrollLeft;
                            const endY =
                                targetRect.top -
                                containerRect.top +
                                container.scrollTop; // To top center of target

                            // Add small offsets to avoid overlapping the node itself
                            const offsetY = 10; // Increased offset
                            const adjustedStartY = startY + offsetY;
                            const adjustedEndY = endY - offsetY;

                            // Ensure start/end points are valid numbers
                            if (
                                isNaN(startX) ||
                                isNaN(adjustedStartY) ||
                                isNaN(endX) ||
                                isNaN(adjustedEndY)
                            ) {
                                console.warn(
                                    "Invalid coordinates for arrow:",
                                    item.concept,
                                    prereqConcept
                                );
                                return;
                            }

                            // Create path - simple curve or straight line depending on positions
                            const path = document.createElementNS(
                                "http://www.w3.org/2000/svg",
                                "path"
                            );

                            // Smoother Bezier curve calculation
                            const dx = endX - startX;
                            const dy = adjustedEndY - adjustedStartY;
                            // Adjust control points for a nice curve, especially for vertical connections
                            const curveFactor = 0.4; // How much curve
                            const cp1x = startX;
                            const cp1y = adjustedStartY + dy * curveFactor;
                            const cp2x = endX;
                            const cp2y = adjustedEndY - dy * curveFactor;

                            const d = `M ${startX},${adjustedStartY} C ${cp1x},${cp1y} ${cp2x},${cp2y} ${endX},${adjustedEndY}`;

                            path.setAttribute("d", d);
                            path.setAttribute("class", "roadmap-arrow");
                            path.setAttribute("stroke", arrowColor); // Set color directly
                            path.setAttribute("marker-end", "url(#arrowhead)");

                            svg.appendChild(path);
                        });
                    }
                });
            }

            // --- View Toggles (Knowledge & Roadmap) ---
            document
                .getElementById("knowledge-graph-btn")
                .addEventListener("click", function () {
                    toggleActiveButton(
                        this,
                        document.getElementById("knowledge-list-btn")
                    );
                    document.getElementById("knowledge-graph").style.display =
                        "block";
                    document.getElementById("knowledge-list").style.display =
                        "none";
                });

            document
                .getElementById("knowledge-list-btn")
                .addEventListener("click", function () {
                    toggleActiveButton(
                        this,
                        document.getElementById("knowledge-graph-btn")
                    );
                    document.getElementById("knowledge-graph").style.display =
                        "none";
                    document.getElementById("knowledge-list").style.display =
                        "block";
                });

            document
                .getElementById("list-view-btn")
                .addEventListener("click", function () {
                    toggleActiveButton(
                        this,
                        document.getElementById("diagram-view-btn")
                    );
                    document.getElementById("roadmap-container").style.display =
                        "block";
                    document.getElementById("roadmap-diagram").style.display =
                        "none";
                });

            document
                .getElementById("diagram-view-btn")
                .addEventListener("click", function () {
                    toggleActiveButton(
                        this,
                        document.getElementById("list-view-btn")
                    );
                    document.getElementById("roadmap-container").style.display =
                        "none";
                    document.getElementById("roadmap-diagram").style.display =
                        "block";
                    // Re-render diagram when switching to ensure arrows are drawn correctly
                    if (diagnosticResults?.learning_roadmap) {
                        createRoadmapDiagram(
                            diagnosticResults.learning_roadmap
                        );
                    }
                });

            function toggleActiveButton(activeBtn, inactiveBtn) {
                activeBtn.classList.add("active", "btn-primary");
                activeBtn.classList.remove("btn-outline-primary");
                inactiveBtn.classList.remove("active", "btn-primary");
                inactiveBtn.classList.add("btn-outline-primary");
            }

            // --- Utility Functions ---

            // Handle fetch responses and basic error checking
            async function handleFetchResponse(response) {
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg =
                            errorData.error || errorData.message || errorMsg;
                    } catch (e) {
                        // If response is not JSON, use status text
                        errorMsg = response.statusText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }
                return response.json(); // Parse JSON body
            }

            // Alert message functionality
            function showAlert(message, type = "info", duration = 5000) {
                // Default type info
                // Clear existing alerts of the same type quickly to avoid spamming
                const existingAlert = alertContainer.querySelector(
                    `.alert-${type}`
                );
                if (existingAlert) {
                    const bsExistingAlert =
                        bootstrap.Alert.getInstance(existingAlert);
                    if (bsExistingAlert) {
                        bsExistingAlert.close();
                    } else {
                        existingAlert.remove();
                    } // Fallback removal
                }

                const alertDiv = document.createElement("div");
                alertDiv.className = `alert alert-${type} alert-dismissible fade show m-2`; // Added margin
                alertDiv.setAttribute("role", "alert");
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                alertContainer.appendChild(alertDiv);

                // Auto dismiss after duration
                if (duration > 0) {
                    setTimeout(() => {
                        // Use Bootstrap's dismiss method if available, otherwise just remove
                        const bsAlert = bootstrap.Alert.getInstance(alertDiv);
                        if (bsAlert) {
                            bsAlert.close();
                        } else {
                            alertDiv.remove(); // Fallback removal
                        }
                    }, duration);
                }
            }

            // Reset functions
            function resetChatState() {
                chatHistory = [];
                chatContainer.innerHTML = "";
                sessionId = null; // Reset session ID for start
                diagnosticResults = null;
                isDiagnosticComplete = false;
                userInput.disabled = false;
                sendMessageBtn.disabled = false;
                completeDiagnosticBtn.disabled = false;
            }

            function resetAppState() {
                resetChatState();
                // Reset setup form fields and stored data
                setupData = { subject: "", goal: "", age: "", grade: "" };
                populateSetupForm(); // Clear the form visually
                startDiagnosticBtn.disabled = false; // Re-enable start button
                // Clear results display (optional, handled by navigateToStage)
                // resultContainer.innerHTML = ""; // Or more specific clearing if needed
            }

            // --- Action Buttons (Results Page) ---

            // Download roadmap results as JSON
            document
                .getElementById("download-roadmap")
                .addEventListener("click", function () {
                    if (!diagnosticResults) {
                        showAlert(
                            "No results available to download.",
                            "warning"
                        );
                        return;
                    }
                    try {
                        // Include setup and history in the download for context
                        const fullData = {
                            sessionId: sessionId,
                            setup: setupData,
                            conversationHistory: chatHistory, // Use the current chat history
                            diagnosticResult: diagnosticResults,
                        };
                        const filename = `learning_navigator_full_session_${
                            sessionId || "session"
                        }.json`;
                        const dataStr =
                            "data:text/json;charset=utf-8," +
                            encodeURIComponent(
                                JSON.stringify(fullData, null, 2) // Use fullData here
                            );
                        const downloadAnchorNode = document.createElement("a");
                        downloadAnchorNode.setAttribute("href", dataStr);
                        downloadAnchorNode.setAttribute("download", filename);
                        document.body.appendChild(downloadAnchorNode);
                        downloadAnchorNode.click();
                        downloadAnchorNode.remove();
                        showAlert(
                            "Full session data (JSON) downloaded successfully!",
                            "success"
                        );
                    } catch (error) {
                        console.error("Error creating download link:", error);
                        showAlert("Failed to prepare download.", "danger");
                    }
                });

            // Print page
            document
                .getElementById("print-roadmap")
                .addEventListener("click", function () {
                    window.print();
                });

            // Share results (Mock - uses session ID for a potential URL)
            document
                .getElementById("share-results")
                .addEventListener("click", function () {
                    if (!sessionId) {
                        showAlert(
                            "Cannot share results without a session ID.",
                            "warning"
                        );
                        return;
                    }
                    // Construct a URL that could potentially display results for this session
                    // This requires a backend route like /result/<session_id>
                    const shareUrl = `${window.location.origin}/result/${sessionId}`;
                    if (navigator.share) {
                        navigator
                            .share({
                                title: "My Learning Roadmap",
                                text: "Check out my personalized learning roadmap from Learning Navigator!",
                                url: shareUrl,
                            })
                            .then(() =>
                                showAlert(
                                    "Shared successfully!", // Removed (mock)
                                    "success"
                                )
                            )
                            .catch((error) => {
                                // Ignore AbortError if user cancels share dialog
                                if (error.name !== "AbortError") {
                                    console.error("Share API error:", error);
                                    showAlert(
                                        "Could not share using system dialog. Link copied instead.",
                                        "info"
                                    );
                                    copyToClipboard(shareUrl); // Fallback to clipboard
                                } else {
                                    console.log("Share cancelled by user.");
                                }
                            });
                    } else {
                        // Fallback for browsers without Share API
                        showAlert(
                            "Share API not supported. Link copied instead.",
                            "info"
                        );
                        copyToClipboard(shareUrl);
                    }
                });

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(
                    () => {
                        showAlert(
                            "Share link copied to clipboard!", // Removed (mock)
                            "success"
                        );
                    },
                    (err) => {
                        console.error("Clipboard copy failed: ", err);
                        showAlert("Failed to copy share link.", "danger");
                    }
                );
            }

            // PDF download (triggers print dialog)
            document
                .getElementById("download-pdf")
                .addEventListener("click", function () {
                    showAlert(
                        "Use your browser's Print to PDF function to save as PDF.",
                        "info",
                        4000
                    );
                    window.print();
                });
        </script>
    </body>
</html>
