<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Learning Navigator Results - {{ subject }}</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <!-- Include the same CSS styles as index.html -->
        <style>
            :root {
                --primary-color: #4361ee;
                --primary-hover: #3a56d4;
                --secondary-color: #3f37c9;
                --accent-color: #4cc9f0;
                --light-bg: #f8f9fa;
                --dark-bg: #212529;
                --light-text: #f8f9fa;
                --dark-text: #212529;
                --user-msg-bg: #e9ecef;
                --assistant-msg-bg: #d8eefe;
                --transition-speed: 0.3s;
                --border-radius: 0.5rem;
            }

            [data-bs-theme="dark"] {
                --light-bg: #212529;
                --dark-bg: #f8f9fa;
                --light-text: #212529;
                --dark-text: #f8f9fa;
                --user-msg-bg: #3a3f44;
                --assistant-msg-bg: #2b3a55;
            }

            body {
                padding-top: 2rem;
                background-color: var(--light-bg);
                transition: background-color var(--transition-speed);
                min-height: 100vh;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            .app-container {
                max-width: 1000px;
                margin: 0 auto;
            }

            .app-header {
                margin-bottom: 2rem;
                text-align: center;
            }

            .app-title {
                font-weight: 700;
                color: var(--primary-color);
                margin-bottom: 0.5rem;
            }

            .app-subtitle {
                font-weight: 400;
                opacity: 0.8;
                margin-bottom: 2rem;
            }

            .card {
                border-radius: var(--border-radius);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: none;
                transition: all var(--transition-speed);
                margin-bottom: 2rem;
            }

            .card-header {
                border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
                background-color: var(--primary-color);
                color: white;
                font-weight: 600;
                padding: 1rem 1.5rem;
            }

            .card-body {
                padding: 1.5rem;
            }

            .btn-primary {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }

            .btn-primary:hover {
                background-color: var(--primary-hover);
                border-color: var(--primary-hover);
            }

            .btn-success {
                background-color: var(--secondary-color);
                border-color: var(--secondary-color);
            }

            .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
            }

            /* Chat Container Styles (for conversation history) */
            .conversation-history-container {
                max-height: 500px; /* Limit height */
                overflow-y: auto;
                border: 1px solid #dee2e6;
                border-radius: var(--border-radius);
                padding: 1rem;
                background-color: white;
                margin-top: 1rem; /* Space above */
                scroll-behavior: smooth;
            }

            [data-bs-theme="dark"] .conversation-history-container {
                background-color: #2b2b2b;
                border-color: #444;
            }

            .message {
                margin-bottom: 1rem;
                padding: 0.75rem 1rem;
                border-radius: var(--border-radius);
                position: relative;
                max-width: 80%;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                /* animation: fadeIn 0.3s ease-in-out; */ /* Optional: remove animation for static view */
            }

            .user-message {
                background-color: var(--user-msg-bg);
                text-align: right;
                margin-left: auto;
                border-bottom-right-radius: 0;
            }

            .assistant-message {
                background-color: var(--assistant-msg-bg);
                margin-right: auto;
                border-bottom-left-radius: 0;
            }

            /* Roadmap Styles */
            .roadmap-container {
                position: relative;
            }

            .roadmap-item {
                border-left: 3px solid var(--primary-color);
                padding: 1rem 1.5rem;
                margin-bottom: 1.5rem;
                position: relative;
                transition: all var(--transition-speed);
            }
            [data-bs-theme="dark"] .roadmap-item {
                border-left-color: var(--primary-hover);
            }

            .roadmap-item:hover {
                background-color: rgba(67, 97, 238, 0.05);
                transform: translateX(5px);
            }
            [data-bs-theme="dark"] .roadmap-item:hover {
                background-color: rgba(67, 97, 238, 0.15);
            }

            .roadmap-item::before {
                content: "";
                position: absolute;
                left: -10px;
                top: 15px; /* Adjusted for better alignment */
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background-color: var(--primary-color);
            }
            [data-bs-theme="dark"] .roadmap-item::before {
                background-color: var(--primary-hover);
            }

            .roadmap-item h5 {
                color: var(--primary-color);
                margin-bottom: 0.5rem;
            }
            [data-bs-theme="dark"] .roadmap-item h5 {
                color: var(--accent-color);
            }

            /* Results page */
            .result-section {
                margin-bottom: 2rem;
            }

            .result-section h4 {
                margin-bottom: 1rem;
                border-bottom: 2px solid var(--primary-color);
                padding-bottom: 0.5rem;
                display: inline-block;
            }
            [data-bs-theme="dark"] .result-section h4 {
                border-bottom-color: var(--primary-hover);
            }

            .list-group-item {
                border-left: 3px solid var(--primary-color);
                margin-bottom: 0.5rem;
                border-radius: var(--border-radius);
                background-color: var(
                    --bs-list-group-bg
                ); /* Use Bootstrap variable */
            }
            [data-bs-theme="dark"] .list-group-item {
                border-left-color: var(--primary-hover);
                background-color: #3a3f44; /* Darker list item */
                color: var(--dark-text);
            }

            /* Toggle Switch */
            .theme-switch-wrapper {
                position: absolute;
                top: 1rem;
                right: 1rem;
                display: flex;
                align-items: center;
                z-index: 1050; /* Ensure it's above other elements */
            }

            .theme-switch {
                display: inline-block;
                height: 26px;
                position: relative;
                width: 50px;
            }

            .theme-switch input {
                display: none;
            }

            .slider {
                background-color: #ccc;
                bottom: 0;
                cursor: pointer;
                left: 0;
                position: absolute;
                right: 0;
                top: 0;
                transition: 0.4s;
                border-radius: 34px;
            }

            .slider:before {
                background-color: white;
                bottom: 4px;
                content: "";
                height: 18px;
                left: 4px;
                position: absolute;
                transition: 0.4s;
                width: 18px;
                border-radius: 50%;
            }

            input:checked + .slider {
                background-color: var(--primary-color);
            }
            input:checked + .slider:before {
                transform: translateX(24px);
            }

            .action-buttons {
                display: flex;
                flex-wrap: wrap; /* Allow wrapping on smaller screens */
                gap: 0.5rem;
                margin-top: 1.5rem;
            }

            /* Skills Tree View */
            .tree-view-toggle {
                margin-bottom: 1rem;
            }

            .skills-tree {
                display: none;
                padding: 1rem;
                background-color: #f8f9fa;
                border-radius: var(--border-radius);
                height: 500px;
                position: relative;
                overflow: hidden;
            }
            [data-bs-theme="dark"] .skills-tree {
                background-color: #2b2b2b;
            }

            .node circle {
                stroke: #fff;
                stroke-width: 2px;
                filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.2));
            }
            [data-bs-theme="dark"] .node circle {
                stroke: #555;
            }

            .node text {
                font-size: 12px;
                font-family: sans-serif;
                fill: var(--dark-text);
            }
            [data-bs-theme="dark"] .node text {
                fill: var(--light-text);
            }

            .link {
                fill: none;
                /* stroke: #ccc; */ /* Style set in JS */
                /* stroke-width: 1.5px; */ /* Style set in JS */
                /* transition: stroke 0.2s; */ /* Transition removed for stability */
            }
            /* [data-bs-theme="dark"] .link { */
            /* stroke: #555; */ /* Style set in JS */
            /* } */

            .node-tooltip {
                position: absolute;
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s;
                max-width: 250px;
                z-index: 100;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            }

            /* Knowledge Graph Styles */
            .knowledge-graph {
                height: 400px;
                background-color: #f8f9fa;
                border-radius: var(--border-radius);
                position: relative;
                overflow: hidden;
                margin-bottom: 2rem;
                border: 1px solid #dee2e6;
            }
            [data-bs-theme="dark"] .knowledge-graph {
                background-color: #2b2b2b;
                border-color: #444;
            }

            .knowledge-node {
                cursor: pointer;
                transition: all 0.2s;
            }
            .knowledge-node:hover {
                /* Handled by JS now */
            }
            .knowledge-list {
                margin-bottom: 2rem;
            }

            .node-proficiency-high {
                fill: #198754;
            }
            .node-proficiency-medium {
                fill: #ffc107;
            }
            .node-proficiency-low {
                fill: #6c757d;
            }

            /* Roadmap Diagram Styles */
            .roadmap-diagram {
                display: none;
                min-height: 400px;
                height: auto;
                background-color: #f8f9fa;
                border-radius: var(--border-radius);
                position: relative;
                overflow: auto;
                padding: 2rem;
                border: 1px solid #dee2e6;
            }
            [data-bs-theme="dark"] .roadmap-diagram {
                background-color: #2b2b2b;
                border-color: #444;
            }

            .roadmap-stage {
                margin-bottom: 3rem;
                position: relative;
            }
            .roadmap-stage-title {
                font-weight: 600;
                margin-bottom: 1.5rem;
                color: var(--primary-color);
                border-bottom: 2px solid var(--primary-color);
                display: inline-block;
                padding-bottom: 0.25rem;
            }
            [data-bs-theme="dark"] .roadmap-stage-title {
                color: var(--accent-color);
                border-bottom-color: var(--accent-color);
            }
            .roadmap-stage-items {
                display: flex;
                flex-wrap: wrap;
                gap: 2rem;
                margin-bottom: 1.5rem;
                position: relative;
                z-index: 2;
            }
            .roadmap-node {
                width: 220px;
                padding: 1rem;
                border-radius: var(--border-radius);
                background-color: white;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                position: relative;
                transition: all 0.3s;
                z-index: 2;
                border: 1px solid #eee;
            }
            [data-bs-theme="dark"] .roadmap-node {
                background-color: #424242;
                color: #e0e0e0;
                border-color: #555;
            }
            .roadmap-node:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            }
            .roadmap-node h5 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
                color: var(--primary-color);
            }
            [data-bs-theme="dark"] .roadmap-node h5 {
                color: var(--accent-color);
            }
            .roadmap-node-description {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
                color: #555;
            }
            [data-bs-theme="dark"] .roadmap-node-description {
                color: #ccc;
            }
            .roadmap-node-prereq {
                font-size: 0.75rem;
                color: #6c757d;
                margin-top: 0.75rem;
                border-top: 1px dashed #eee;
                padding-top: 0.5rem;
            }
            [data-bs-theme="dark"] .roadmap-node-prereq {
                color: #aaa;
                border-top-color: #555;
            }
            .roadmap-arrows {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
                overflow: visible;
            }
            .roadmap-arrow {
                fill: none;
                stroke: #adb5bd;
                stroke-width: 1.5px;
                stroke-opacity: 0.7;
                marker-end: url(#arrowhead);
                transition: stroke-opacity 0.2s;
            }
            [data-bs-theme="dark"] .roadmap-arrow {
                stroke: #666;
            }
            .roadmap-arrow:hover {
                stroke-opacity: 1;
            }

            /* Alert styling */
            .alert-container {
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1055;
                width: auto;
                max-width: 90%;
            }
            .alert {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            /* Mobile improvements */
            @media (max-width: 768px) {
                .action-buttons {
                    flex-direction: column;
                    align-items: stretch;
                }
                .action-buttons .btn {
                    width: 100%;
                }
                .roadmap-item {
                    padding-left: 1rem;
                    padding-right: 1rem;
                }
                .roadmap-stage-items {
                    flex-direction: column;
                    align-items: center;
                }
                .roadmap-node {
                    width: 90%;
                }
                .theme-switch-wrapper {
                    top: 0.5rem;
                    right: 0.5rem;
                }
                body {
                    padding-top: 1rem;
                }
                .app-title {
                    font-size: 1.75rem;
                }
                .app-subtitle {
                    font-size: 0.9rem;
                    margin-bottom: 1.5rem;
                }
                .message {
                    max-width: 90%; /* Adjust message width on mobile */
                }
            }
        </style>
    </head>
    <body>
        <div class="theme-switch-wrapper">
            <label class="theme-switch">
                <input type="checkbox" id="theme-toggle" />
                <span class="slider"></span>
            </label>
            <span class="ms-2" id="theme-label">Dark Mode</span>
        </div>

        <!-- Alert Container -->
        <div id="alert-container" class="alert-container"></div>

        <div class="container app-container">
            <div class="app-header">
                <h1 class="app-title">Learning Navigator Results</h1>
                <p class="app-subtitle">
                    Subject: <strong>{{ subject }}</strong> | Goal:
                    <strong>{{ goal }}</strong> <br /><small class="text-muted"
                        >Session ID: {{ session_id }}</small
                    >
                </p>
            </div>

            <!-- Setup Information Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">Initial Setup</h3>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Subject</dt>
                        <dd class="col-sm-9">{{ subject }}</dd>

                        <dt class="col-sm-3">Goal</dt>
                        <dd class="col-sm-9">{{ goal }}</dd>

                        {% if age %}
                        <dt class="col-sm-3">Age</dt>
                        <dd class="col-sm-9">{{ age }}</dd>
                        {% endif %} {% if grade %}
                        <dt class="col-sm-3">Grade</dt>
                        <dd class="col-sm-9">{{ grade }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Conversation History Section (Collapsible) -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3
                        class="mb-0 d-flex justify-content-between align-items-center"
                    >
                        Diagnostic Conversation
                        <button
                            class="btn btn-sm btn-outline-light"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#conversationCollapse"
                            aria-expanded="false"
                            aria-controls="conversationCollapse"
                        >
                            Show/Hide <i class="bi bi-chevron-down"></i>
                        </button>
                    </h3>
                </div>
                <div class="collapse" id="conversationCollapse">
                    <div class="card-body">
                        {% if conversation_history %}
                        <div class="conversation-history-container">
                            {% for message in conversation_history %}
                            <div
                                class="message {{ 'user-message' if message.role == 'user' else 'assistant-message' }}"
                            >
                                <!-- Use safe filter or ensure marked sanitizes -->
                                {{ message.content | safe }}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">
                            Conversation history not available.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Result Section -->
            <div id="result-container">
                <div class="card">
                    <div
                        class="card-header d-flex justify-content-between align-items-center"
                    >
                        <h3 class="mb-0">Your Diagnostic Results</h3>
                        <div class="action-buttons-header">
                            <button
                                id="copy-link"
                                class="btn btn-outline-light"
                                title="Copy Link to Results"
                            >
                                <i class="bi bi-link-45deg"></i>
                            </button>
                            <button
                                id="download-pdf"
                                class="btn btn-outline-light"
                                title="Download as PDF (Print)"
                            >
                                <i class="bi bi-download"></i>
                            </button>
                            <button
                                id="share-results"
                                class="btn btn-outline-light"
                                title="Share Results (mock)"
                            >
                                <i class="bi bi-share"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <!-- Changed from success -->
                            <i class="bi bi-info-circle-fill"></i> Displaying
                            your personalized results for session
                            <strong>{{ session_id }}</strong>.
                        </div>

                        <div class="result-section">
                            <h4>Your Knowledge</h4>
                            <div class="knowledge-view-toggle mb-3">
                                <div class="btn-group" role="group">
                                    <button
                                        type="button"
                                        class="btn btn-primary active"
                                        id="knowledge-graph-btn"
                                    >
                                        Knowledge Map
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        id="knowledge-list-btn"
                                    >
                                        List View
                                    </button>
                                </div>
                            </div>
                            <div
                                id="knowledge-graph"
                                class="knowledge-graph"
                            ></div>
                            <div
                                id="knowledge-list"
                                class="knowledge-list"
                                style="display: none"
                            ></div>
                        </div>

                        <div class="row result-section">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h4>Your Strengths</h4>
                                <ul id="strengths-list" class="list-group"></ul>
                            </div>
                            <div class="col-md-6">
                                <h4>Areas to Improve</h4>
                                <ul id="gaps-list" class="list-group"></ul>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Your Personalized Learning Roadmap</h4>
                            <div class="tree-view-toggle">
                                <div class="btn-group" role="group">
                                    <button
                                        type="button"
                                        class="btn btn-primary active"
                                        id="list-view-btn"
                                    >
                                        List View
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        id="diagram-view-btn"
                                    >
                                        Diagram View
                                    </button>
                                </div>
                            </div>
                            <div
                                id="roadmap-container"
                                class="roadmap-container mt-3"
                            ></div>
                            <div
                                id="roadmap-diagram"
                                class="roadmap-diagram mt-3"
                            ></div>
                        </div>

                        <div class="result-section">
                            <h4>Recommendations</h4>
                            <ul
                                id="recommendations-list"
                                class="list-group"
                            ></ul>
                        </div>

                        <div class="result-section">
                            <h4>Your Interests</h4>
                            <p
                                id="interests-display"
                                class="p-3 rounded border"
                            ></p>
                        </div>

                        <div class="action-buttons">
                            <button
                                id="download-roadmap"
                                class="btn btn-primary"
                            >
                                <i class="bi bi-download"></i> Download Results
                                (JSON)
                            </button>
                            <button
                                id="print-roadmap"
                                class="btn btn-outline-primary"
                            >
                                <i class="bi bi-printer"></i> Print Page
                            </button>
                            <a href="/" class="btn btn-outline-secondary">
                                <i class="bi bi-plus-circle"></i> Start New
                                Assessment
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // --- Global State Variables ---
            // Data is passed directly from Flask template
            const diagnosticResults = {{ diagnostic_result | tojson }};
            const sessionId = "{{ session_id }}"; // Get session ID from template
            const conversationHistory = {{ conversation_history | tojson }}; // Get history

            // --- DOM Elements ---
            const themeToggle = document.getElementById('theme-toggle');
            const themeLabel = document.getElementById('theme-label');
            const alertContainer = document.getElementById('alert-container');
            const conversationContainer = document.querySelector('.conversation-history-container'); // Get conversation container

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', () => {
                // Set initial theme
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && prefersDark)) {
                    themeToggle.checked = true;
                    document.documentElement.setAttribute('data-bs-theme', 'dark');
                    themeLabel.textContent = 'Light Mode';
                } else {
                    document.documentElement.setAttribute('data-bs-theme', 'light');
                    themeLabel.textContent = 'Dark Mode';
                }

                // Render conversation history using marked.js
                renderConversationHistory();

                // Display results passed from Flask
                if (diagnosticResults) {
                    displayResults(diagnosticResults);
                } else {
                    showAlert('Error: Diagnostic results data not found.', 'danger');
                    // Hide the results card if data is missing
                    document.getElementById('result-container').style.display = 'none';
                }
            });

            // --- Theme Switcher ---
            themeToggle.addEventListener('change', function () {
                if (this.checked) {
                    document.documentElement.setAttribute('data-bs-theme', 'dark');
                    themeLabel.textContent = 'Light Mode';
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-bs-theme', 'light');
                    themeLabel.textContent = 'Dark Mode';
                    localStorage.setItem('theme', 'light');
                }
                // Re-render graphs if visible to apply theme changes
                if (diagnosticResults) {
                     if (document.getElementById('knowledge-graph').style.display !== 'none') {
                        // Graph needs full redraw for theme changes in nodes/links/text
                        createKnowledgeGraph(diagnosticResults.knowledge_graph);
                     }
                     if (document.getElementById('roadmap-diagram').style.display !== 'none') {
                        // Roadmap diagram also needs redraw for theme changes
                        createRoadmapDiagram(diagnosticResults.learning_roadmap);
                     }
                }
                // Re-render conversation history for theme change
                renderConversationHistory();
            });

            // --- Render Conversation History ---
            function renderConversationHistory() {
                if (!conversationContainer) return; // Exit if container not found
                conversationContainer.innerHTML = ''; // Clear existing content

                if (conversationHistory && conversationHistory.length > 0) {
                    conversationHistory.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${message.role === 'user' ? 'user-message' : 'assistant-message'}`;
                        // Use marked.parse() - ensure it's configured to sanitize if needed, or trust the source
                        // Added check for null/undefined content
                        messageDiv.innerHTML = marked.parse(message.content || '*No content provided*');
                        conversationContainer.appendChild(messageDiv);
                    });
                } else {
                    conversationContainer.innerHTML = '<p class="text-muted p-3">Conversation history not available.</p>';
                }
            }


            // --- Result Display Logic (Adapted from index.html) ---
            function displayResults(results) {
                console.log("Displaying results:", results);

                // Populate strengths
                const strengthsList = document.getElementById('strengths-list');
                strengthsList.innerHTML = results.diagnostic_summary?.strengths?.length > 0
                    ? results.diagnostic_summary.strengths.map(s => `<li class="list-group-item">${marked.parseInline(s || '')}</li>`).join('') // Added check for null s
                    : '<li class="list-group-item text-muted">No specific strengths identified.</li>';

                // Populate gaps
                const gapsList = document.getElementById('gaps-list');
                gapsList.innerHTML = results.diagnostic_summary?.gaps?.length > 0
                    ? results.diagnostic_summary.gaps.map(g => `<li class="list-group-item">${marked.parseInline(g || '')}</li>`).join('') // Added check for null g
                    : '<li class="list-group-item text-muted">No specific areas for improvement identified.</li>';

                // Create Knowledge Graph & List
                if (results.knowledge_graph && results.knowledge_graph.nodes) {
                    createKnowledgeGraph(results.knowledge_graph); // Create graph first
                    createKnowledgeList(results.knowledge_graph); // Then list
                    document.getElementById('knowledge-graph').style.display = 'block'; // Show graph by default
                    document.getElementById('knowledge-list').style.display = 'none';
                    document.getElementById('knowledge-graph-btn').classList.add('active', 'btn-primary');
                    document.getElementById('knowledge-graph-btn').classList.remove('btn-outline-primary');
                    document.getElementById('knowledge-list-btn').classList.remove('active', 'btn-primary');
                    document.getElementById('knowledge-list-btn').classList.add('btn-outline-primary');
                } else {
                    document.getElementById('knowledge-graph').innerHTML = '<p class="text-center text-muted p-3">Knowledge map data not available.</p>';
                    document.getElementById('knowledge-list').innerHTML = '<p class="text-center text-muted p-3">Knowledge list data not available.</p>';
                }

                // Populate roadmap list view
                const roadmapContainer = document.getElementById('roadmap-container');
                if (results.learning_roadmap && results.learning_roadmap.length > 0) {
                    roadmapContainer.innerHTML = results.learning_roadmap.map((item, index) => `
                        <div class="roadmap-item" data-id="${item.id || `roadmap-item-${index}`}"> <!-- Ensure unique ID -->
                            <h5>${index + 1}. ${marked.parseInline(item.concept || 'Unnamed Step')}</h5>
                            <p>${marked.parseInline(item.description || '')}</p>
                            <p class="mb-1"><strong>Prerequisites:</strong> ${item.prerequisites?.join(', ') || 'None'}</p>
                            <p><strong>Suggested Resources:</strong> ${item.resources?.join(', ') || 'General study'}</p>
                        </div>
                    `).join('');

                    // Create Roadmap Diagram View (but keep it hidden initially)
                    createRoadmapDiagram(results.learning_roadmap);
                    document.getElementById('roadmap-container').style.display = 'block'; // Show list view by default
                    document.getElementById('roadmap-diagram').style.display = 'none';
                    document.getElementById('list-view-btn').classList.add('active', 'btn-primary');
                    document.getElementById('list-view-btn').classList.remove('btn-outline-primary');
                    document.getElementById('diagram-view-btn').classList.remove('active', 'btn-primary');
                    document.getElementById('diagram-view-btn').classList.add('btn-outline-primary');
                } else {
                    roadmapContainer.innerHTML = '<p class="text-center text-muted p-3">Learning roadmap not available.</p>';
                    document.getElementById('roadmap-diagram').innerHTML = '<p class="text-center text-muted p-3">Roadmap diagram not available.</p>';
                }

                // Populate recommendations
                const recommendationsList = document.getElementById('recommendations-list');
                recommendationsList.innerHTML = results.recommendations?.length > 0
                    ? results.recommendations.map(r => `<li class="list-group-item">${marked.parse(r || '')}</li>`).join('') // Added check for null r
                    : '<li class="list-group-item text-muted">No specific recommendations provided.</li>';

                // Populate interests
                document.getElementById('interests-display').textContent = results.user_interests?.join(', ') || 'No specific interests recorded.';
            }

            // --- d3 Visualizations ---

            function createKnowledgeGraph(knowledgeData) {
                const graphContainer = d3.select("#knowledge-graph");
                graphContainer.html(""); // Clear previous graph - NECESSARY for resize/theme changes

                if (!knowledgeData || !knowledgeData.nodes || knowledgeData.nodes.length === 0) {
                    graphContainer.append("div").attr("class", "text-center text-muted py-5").text("No knowledge data available for map view.");
                    return;
                }
                console.log("Creating knowledge graph..."); // Debug log

                const tooltip = graphContainer.append("div").attr("class", "node-tooltip").style("opacity", 0);
                const width = graphContainer.node().getBoundingClientRect().width;
                const height = 400; // Fixed height

                const svg = graphContainer.append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height])
                    .style("max-width", "100%")
                    .style("height", "auto");

                const g = svg.append("g");

                // Define zoom AFTER svg is created
                const zoom = d3.zoom().scaleExtent([0.3, 4]).on("zoom", (event) => {
                    g.attr("transform", event.transform);
                    // Adjust stroke width based on zoom ONLY for elements that need it (like nodes)
                    g.selectAll(".node circle").attr("stroke-width", 2 / event.transform.k);
                    // Links might not need zoom-adjusted width, or use a different factor
                    g.selectAll(".link").attr("stroke-width", 1.5 / event.transform.k);
                });
                svg.call(zoom); // Apply zoom to svg

                // Filter links to ensure both source and target nodes exist
                const nodeIds = new Set(knowledgeData.nodes.map(n => n.id));
                const validLinks = (knowledgeData.links || []).filter(link =>
                    nodeIds.has(link.source) && nodeIds.has(link.target)
                );
                console.log(`Found ${knowledgeData.nodes.length} nodes, ${validLinks.length} valid links.`); // Debug log

                const simulation = d3.forceSimulation(knowledgeData.nodes)
                    .force("link", d3.forceLink(validLinks).id(d => d.id).distance(100).strength(0.5))
                    .force("charge", d3.forceManyBody().strength(-350))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("x", d3.forceX(width / 2).strength(0.05))
                    .force("y", d3.forceY(height / 2).strength(0.05))
                    .force("collision", d3.forceCollide().radius(30));

                svg.append("defs").append("marker")
                    .attr("id", "knowledge-arrow")
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 25) // Adjusted refX based on node radius + desired gap
                    .attr("refY", 0)
                    .attr("markerWidth", 5)
                    .attr("markerHeight", 5)
                    .attr("orient", "auto")
                    .append("path")
                    .attr("d", "M0,-5L10,0L0,5")
                    .attr("fill", "#999"); // Initial fill, might be overridden by resetHighlighting

                const link = g.append("g").attr("class", "links")
                    .selectAll("line").data(validLinks).join("line")
                    .attr("class", "link")
                    .attr("marker-end", "url(#knowledge-arrow)")
                    .attr("stroke-dasharray", d => d.relationship === "relates_to" ? "4,4" : "none");

                const node = g.append("g").attr("class", "nodes")
                    .selectAll(".node").data(knowledgeData.nodes).join("g")
                    .attr("class", "node knowledge-node")
                    .call(drag(simulation));

                node.append("circle")
                    .attr("r", 14)
                    .attr("class", d => `node-proficiency-${d.proficiency || "low"}`) // Apply proficiency class
                    .on("mouseover", function(event, d) {
                        tooltip.transition().duration(200).style("opacity", 0.9);
                        tooltip.html(`<strong>${d.name || "Unnamed"}</strong><br>${d.description || "No description."}<br><em>Proficiency: ${d.proficiency || "Unknown"}</em>`);
                        const [x, y] = d3.pointer(event, graphContainer.node());
                        tooltip.style("left", (x + 15) + "px").style("top", (y - 28) + "px");
                        highlightConnections(d, node, link, svg); // Pass svg
                    })
                    .on("mouseout", function() {
                        tooltip.transition().duration(300).style("opacity", 0);
                        resetHighlighting(node, link, svg); // Pass svg
                    });

                node.append("text")
                    .attr("dx", 18)
                    .attr("dy", ".35em")
                    .attr("font-size", "11px")
                    .text(d => d.name || "Unnamed");

                simulation.on("tick", () => {
                    // Update link positions
                    link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                    // Update node positions
                    node.attr("transform", d => `translate(${d.x},${d.y})`);
                });

                // Call resetHighlighting AFTER simulation setup and tick handler attachment
                // This ensures initial styles are applied correctly.
                resetHighlighting(node, link, svg);
            }

            function drag(simulation) {
                function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
                function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
                function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
                return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
            }

            function highlightConnections(selectedNode, allNodes, allLinks, svg) {
                const connectedNodeIds = new Set(); connectedNodeIds.add(selectedNode.id);
                const currentZoom = d3.zoomTransform(svg.node()).k || 1; // Ensure zoom is at least 1

                allLinks.each(function(l) {
                    const linkElement = d3.select(this);
                    // Check if source/target are objects with id (they should be after simulation runs)
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;

                    if (sourceId === selectedNode.id || targetId === selectedNode.id) {
                        linkElement.transition().duration(150)
                           .attr("stroke", "#f00") // Highlight color
                           .attr("stroke-opacity", 1)
                           .attr("stroke-width", (2 / currentZoom)); // Make highlighted links thicker
                        connectedNodeIds.add(sourceId);
                        connectedNodeIds.add(targetId);
                    } else {
                        linkElement.transition().duration(150).attr("stroke-opacity", 0.2); // Fade out non-connected
                    }
                });
                allNodes.each(function(n) {
                    const nodeElement = d3.select(this);
                    nodeElement.transition().duration(150).style("opacity", connectedNodeIds.has(n.id) ? 1 : 0.3); // Fade non-connected nodes
                });
            }

            function resetHighlighting(allNodes, allLinks, svg) {
                const currentZoom = d3.zoomTransform(svg.node()).k || 1; // Ensure zoom is at least 1
                const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                const linkColor = isDark ? "#555" : "#ccc";
                const markerColor = isDark ? "#666" : "#999"; // Adjust marker color too

                allNodes.transition().duration(200).style("opacity", 1); // Reset node opacity

                // *** FIX: Apply styles directly without transition for links ***
                // Transitions on links immediately after creation/simulation start
                // can be unreliable and cause visibility issues.
                allLinks //.transition().duration(200) // REMOVED transition
                    .attr("stroke", linkColor)
                    .attr("stroke-opacity", 0.7)
                    .attr("stroke-width", 1.5 / currentZoom); // Reset link style directly

                // Update marker color based on theme
                svg.select("#knowledge-arrow path").attr("fill", markerColor);
            }


            function createKnowledgeList(knowledgeData) {
                const knowledgeList = document.getElementById('knowledge-list');
                knowledgeList.innerHTML = '';

                if (!knowledgeData || !knowledgeData.nodes || knowledgeData.nodes.length === 0) {
                    knowledgeList.innerHTML = "<p class='text-center text-muted py-3'>No knowledge data available for list view.</p>";
                    return;
                }

                const proficiencyGroups = { high: [], medium: [], low: [], unknown: [] };
                knowledgeData.nodes.forEach(node => {
                    (proficiencyGroups[node.proficiency] || proficiencyGroups.unknown).push(node);
                });

                const createSection = (title, items) => {
                    if (items.length === 0) return '';
                    return `
                        <div class="mb-3">
                            <h5>${title}</h5>
                            <ul class="list-group">
                                ${items.map(item => `
                                    <li class="list-group-item">
                                        <strong>${marked.parseInline(item.name || 'Unnamed')}</strong>
                                        <p class="mb-0 mt-1" style="font-size: 0.875rem;">${marked.parseInline(item.description || 'No description.')}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                };

                knowledgeList.innerHTML = createSection('Strong Knowledge', proficiencyGroups.high) +
                                          createSection('Familiar', proficiencyGroups.medium) +
                                          createSection('Basic Understanding / Needs Review', proficiencyGroups.low) +
                                          createSection('Proficiency Not Assessed', proficiencyGroups.unknown);
            }

            function createRoadmapDiagram(roadmapData) {
                const container = document.getElementById('roadmap-diagram');
                container.innerHTML = ''; // Clear previous diagram

                if (!roadmapData || roadmapData.length === 0) {
                    container.innerHTML = "<p class='text-center text-muted py-5'>No roadmap data available for diagram view.</p>";
                    return;
                }
                console.log("Creating roadmap diagram..."); // Debug log

                const stageGroups = { beginner: [], intermediate: [], advanced: [], other: [] };
                const conceptToIdMap = {};
                let idCounter = 0;

                // Ensure unique IDs and map concepts to IDs
                roadmapData.forEach((item, index) => {
                    // Assign a unique ID if missing or if concept name is duplicated (simple approach)
                    if (!item.id || conceptToIdMap[item.concept]) {
                         item.id = `roadmap-node-${item.concept ? item.concept.replace(/\s+/g, '-') : ''}-${idCounter++}`;
                    }
                    // Ensure ID is valid for DOM querySelector
                    item.id = item.id.replace(/[^a-zA-Z0-9-_]/g, '_'); // Sanitize ID
                    conceptToIdMap[item.concept] = item.id;

                    const stage = item.stage?.toLowerCase() || 'other';
                    (stageGroups[stage] || stageGroups.other).push(item);
                });

                const arrowsContainer = document.createElement('div');
                arrowsContainer.className = 'roadmap-arrows';
                const arrowsSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                arrowsContainer.appendChild(arrowsSvg);

                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.setAttribute('id', 'arrowhead');
                marker.setAttribute('viewBox', '0 -5 10 10');
                marker.setAttribute('refX', '8'); // Arrow tip position relative to end of line
                marker.setAttribute('refY', '0');
                marker.setAttribute('markerWidth', '5');
                marker.setAttribute('markerHeight', '5');
                marker.setAttribute('orient', 'auto-start-reverse'); // Ensures arrow points correctly
                const pathMarker = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                pathMarker.setAttribute('d', 'M0,-5L10,0L0,5');
                // pathMarker.setAttribute('fill', '#adb5bd'); // Color set in drawRoadmapConnections
                marker.appendChild(pathMarker);
                defs.appendChild(marker);
                arrowsSvg.appendChild(defs);

                const stageOrder = ['beginner', 'intermediate', 'advanced', 'other'];
                stageOrder.forEach(stageKey => {
                    const group = stageGroups[stageKey];
                    if (group.length > 0) {
                        const stageSection = document.createElement('div');
                        stageSection.className = 'roadmap-stage';
                        stageSection.dataset.stage = stageKey;
                        const stageTitle = document.createElement('h5');
                        stageTitle.className = 'roadmap-stage-title';
                        stageTitle.textContent = stageKey.charAt(0).toUpperCase() + stageKey.slice(1);
                        stageSection.appendChild(stageTitle);
                        const stageItems = document.createElement('div');
                        stageItems.className = 'roadmap-stage-items';
                        group.forEach(item => {
                            const itemNode = document.createElement('div');
                            itemNode.className = 'roadmap-node';
                            itemNode.id = item.id; // Use the generated/sanitized ID
                            itemNode.innerHTML = `
                                <h5>${marked.parseInline(item.concept || 'Unnamed Step')}</h5>
                                <div class="roadmap-node-description">${marked.parseInline(item.description || '')}</div>
                                ${item.prerequisites && item.prerequisites.length > 0 ? `
                                <div class="roadmap-node-prereq">
                                    <strong>Prerequisites:</strong> ${item.prerequisites.join(', ')}
                                </div>` : ''}
                            `;
                            stageItems.appendChild(itemNode);
                        });
                        stageSection.appendChild(stageItems);
                        container.appendChild(stageSection);
                    }
                });

                container.appendChild(arrowsContainer); // Add arrows container last

                // Use requestAnimationFrame to ensure layout is calculated before drawing arrows
                requestAnimationFrame(() => {
                    // A small timeout can sometimes help ensure elements are fully rendered
                    setTimeout(() => {
                        drawRoadmapConnections(roadmapData, arrowsSvg, conceptToIdMap);
                    }, 100); // Increased timeout slightly
                });
            }

            function drawRoadmapConnections(roadmapData, svg, conceptToIdMap) {
                // Clear only paths, keep defs
                d3.select(svg).selectAll('path:not(defs path)').remove();

                const container = svg.parentElement.parentElement; // The main roadmap-diagram container
                const containerRect = container.getBoundingClientRect();
                if (containerRect.width === 0 || containerRect.height === 0) {
                    console.warn("Roadmap container has zero dimensions, cannot draw arrows.");
                    return;
                 } // Don't draw if container isn't visible

                svg.setAttribute('width', container.scrollWidth);
                svg.setAttribute('height', container.scrollHeight);

                const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                const arrowColor = isDark ? "#666" : "#adb5bd";
                d3.select(svg).select('#arrowhead path').attr('fill', arrowColor); // Set marker color

                roadmapData.forEach(item => {
                    if (item.prerequisites && item.prerequisites.length > 0) {
                        const targetElement = document.getElementById(item.id);
                        if (!targetElement) {
                            console.warn(`Target element not found for ID: ${item.id}`);
                            return;
                        }
                        const targetRect = targetElement.getBoundingClientRect();

                        item.prerequisites.forEach(prereqConcept => {
                            const sourceId = conceptToIdMap[prereqConcept];
                            if (!sourceId) {
                                console.warn(`Source ID not found for concept: ${prereqConcept}`);
                                return;
                            }
                            const sourceElement = document.getElementById(sourceId);
                            if (!sourceElement) {
                                console.warn(`Source element not found for ID: ${sourceId}`);
                                return;
                            }
                            const sourceRect = sourceElement.getBoundingClientRect();

                            // Calculate coordinates relative to the SVG container
                            const startX = sourceRect.left + sourceRect.width / 2 - containerRect.left + container.scrollLeft;
                            const startY = sourceRect.bottom - containerRect.top + container.scrollTop; // From bottom of source
                            const endX = targetRect.left + targetRect.width / 2 - containerRect.left + container.scrollLeft;
                            const endY = targetRect.top - containerRect.top + container.scrollTop; // To top of target

                            const offsetY = 10; // Add vertical gap between node and arrow start/end
                            const adjustedStartY = startY + offsetY;
                            const adjustedEndY = endY - offsetY;

                            // Ensure start/end points are valid numbers
                            if (isNaN(startX) || isNaN(adjustedStartY) || isNaN(endX) || isNaN(adjustedEndY)) {
                                console.warn("Invalid coordinates for arrow:", item.concept, prereqConcept);
                                return;
                            }

                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            const dx = endX - startX;
                            const dy = adjustedEndY - adjustedStartY;

                            // Simple straight line or curved path
                            let d;
                            if (Math.abs(dx) < 5 && dy > 0) { // Mostly vertical connection
                                d = `M ${startX},${adjustedStartY} L ${endX},${adjustedEndY}`;
                            } else { // Use a curve for non-vertical
                                const curveFactor = 0.4; // Adjust for more/less curve
                                const cp1x = startX;
                                const cp1y = adjustedStartY + dy * curveFactor;
                                const cp2x = endX;
                                const cp2y = adjustedEndY - dy * curveFactor;
                                d = `M ${startX},${adjustedStartY} C ${cp1x},${cp1y} ${cp2x},${cp2y} ${endX},${adjustedEndY}`;
                            }


                            path.setAttribute('d', d);
                            path.setAttribute('class', 'roadmap-arrow');
                            path.setAttribute('stroke', arrowColor); // Set color directly
                            path.setAttribute('marker-end', 'url(#arrowhead)');
                            svg.appendChild(path);
                        });
                    }
                });
            }


            // --- View Toggles (Knowledge & Roadmap) ---
            document.getElementById('knowledge-graph-btn').addEventListener('click', function() {
                toggleActiveButton(this, document.getElementById('knowledge-list-btn'));
                document.getElementById('knowledge-graph').style.display = 'block';
                document.getElementById('knowledge-list').style.display = 'none';
            });

            document.getElementById('knowledge-list-btn').addEventListener('click', function() {
                toggleActiveButton(this, document.getElementById('knowledge-graph-btn'));
                document.getElementById('knowledge-graph').style.display = 'none';
                document.getElementById('knowledge-list').style.display = 'block';
                // No need to recreate list view, it's static HTML
            });

            document.getElementById('list-view-btn').addEventListener('click', function() {
                toggleActiveButton(this, document.getElementById('diagram-view-btn'));
                document.getElementById('roadmap-container').style.display = 'block';
                document.getElementById('roadmap-diagram').style.display = 'none';
            });

            document.getElementById('diagram-view-btn').addEventListener('click', function() {
                toggleActiveButton(this, document.getElementById('list-view-btn'));
                document.getElementById('roadmap-container').style.display = 'none';
                document.getElementById('roadmap-diagram').style.display = 'block';
                // Re-create diagram when switching to it to ensure arrows are drawn correctly
                if (diagnosticResults?.learning_roadmap) {
                    createRoadmapDiagram(diagnosticResults.learning_roadmap);
                }
            });

            function toggleActiveButton(activeBtn, inactiveBtn) {
                activeBtn.classList.add('active', 'btn-primary');
                activeBtn.classList.remove('btn-outline-primary');
                inactiveBtn.classList.remove('active', 'btn-primary');
                inactiveBtn.classList.add('btn-outline-primary');
            }

            // --- Utility Functions ---
            function showAlert(message, type = 'info', duration = 5000) {
                // Clear existing alerts of the same type to prevent stacking
                const existingAlert = alertContainer.querySelector(`.alert-${type}`);
                if (existingAlert) {
                    const bsExistingAlert = bootstrap.Alert.getInstance(existingAlert);
                    if (bsExistingAlert) { bsExistingAlert.close(); }
                    else { existingAlert.remove(); } // Fallback removal
                 }

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show m-2`;
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
                alertContainer.appendChild(alertDiv);

                if (duration > 0) {
                    setTimeout(() => {
                        const bsAlert = bootstrap.Alert.getInstance(alertDiv);
                        if (bsAlert) { bsAlert.close(); }
                        else { alertDiv.remove(); } // Fallback removal
                    }, duration);
                }
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('Link copied to clipboard!', 'success');
                }, (err) => {
                    console.error('Clipboard copy failed: ', err);
                    showAlert('Failed to copy link.', 'danger');
                });
            }

            // --- Action Buttons (Results Page) ---
            document.getElementById('download-roadmap').addEventListener('click', function() {
                if (!diagnosticResults) { showAlert('No results available to download.', 'warning'); return; }
                try {
                    // Include setup and history in the download
                    const fullData = {
                        sessionId: sessionId,
                        setup: {
                            subject: "{{ subject }}",
                            goal: "{{ goal }}",
                            age: "{{ age }}",
                            grade: "{{ grade }}"
                        },
                        conversationHistory: conversationHistory,
                        diagnosticResult: diagnosticResults
                    };
                    const filename = `learning_navigator_full_session_${sessionId}.json`;
                    const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(fullData, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute('href', dataStr);
                    downloadAnchorNode.setAttribute('download', filename);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    showAlert('Full session data (JSON) downloaded successfully!', 'success');
                } catch (error) {
                    console.error('Error creating download link:', error);
                    showAlert('Failed to prepare download.', 'danger');
                }
            });

            document.getElementById('print-roadmap').addEventListener('click', function() { window.print(); });

            document.getElementById('copy-link').addEventListener('click', function() {
                copyToClipboard(window.location.href);
            });

            document.getElementById('share-results').addEventListener('click', function() {
                const shareUrl = window.location.href;
                if (navigator.share) {
                    navigator.share({
                        title: 'My Learning Roadmap',
                        text: 'Check out my personalized learning roadmap from Learning Navigator!',
                        url: shareUrl,
                    }).then(() => showAlert('Shared successfully!', 'success'))
                      .catch((error) => {
                          // Ignore AbortError if user cancels share dialog
                          if (error.name !== 'AbortError') {
                             console.error('Share API error:', error);
                             showAlert('Could not share using system dialog. Link copied instead.', 'info');
                             copyToClipboard(shareUrl); // Fallback to clipboard
                          } else {
                             console.log('Share cancelled by user.');
                          }
                      });
                } else {
                    showAlert('Share API not supported. Link copied instead.', 'info');
                    copyToClipboard(shareUrl); // Fallback for browsers without Share API
                }
            });

            document.getElementById('download-pdf').addEventListener('click', function() {
                // Changed to just trigger print, as PDF generation is complex client-side
                showAlert('Use your browser\'s Print to PDF function to save as PDF.', 'info', 4000);
                window.print();
            });
        </script>
    </body>
</html>
